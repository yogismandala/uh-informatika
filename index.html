<!doctype html>
<html lang="id" class="min-h-screen">
    <head>
        <meta charset="UTF-8">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=overlays-content">
        <title>SMPN 11 TANGERANG</title>
        <link rel="icon" type="image/png" href="https://i.ibb.co.com/99y5fNyw/LOGO-11.png">
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
        <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        
        

        <style>
            #questionContainer .flex.items-center p,
            #questionContainer .flex.items-start p {
                display: inline !important;
                margin: 0;
            }

            /* Pastikan container opsinya menggunakan flex-start agar huruf A sejajar di atas */
            .option-item {
                display: flex;
                align-items: flex-start; /* Sejajar dengan baris pertama teks */
                gap: 8px;
            }



            .ql-container {
                height: auto !important;
                min-height: 60px;
            }

            /* Tambahkan padding di bawah modal SweetAlert agar tombol konfirmasi tidak menutupi editor */
            .swal2-html-container {
                margin-bottom: 20px !important;
            }

            /* Mengatur agar toolbar tetap rapi */
            .ql-toolbar.ql-snow {
                border-radius: 5px 5px 0 0;
                padding: 2px !important;
            }

            /* Efek Glassmorphism untuk Form Login */
            .glass-panel {
                background: rgba(255, 255, 255, 0.2); /* Transparansi putih */
                backdrop-filter: blur(15px);          /* Efek blur kaca */
                -webkit-backdrop-filter: blur(15px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                border-radius: 20px;
            }

            /* Penyesuaian input agar senada dengan efek kaca */
            .glass-input {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
            }

            .glass-input::placeholder {
                color: rgba(255, 255, 255, 0.7);
            }

            .glass-input:focus {
                background: rgba(255, 255, 255, 0.2);
                border-color: rgba(255, 255, 255, 0.5);
                color: white;
            }
                    
            .gradient-header {
                background: linear-gradient(135deg, #60a5fa 0%, #1e40af 100%);
            }
            
            .gradient-bg {
                background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            }
            
            .shadow-custom {
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            }
            
            .question-nav-btn {
                width: 45px;
                height: 45px;
                transition: all 0.2s ease;
            }
            
            .question-nav-btn:hover {
                transform: scale(1.05);
            }
            
            .answered {
                background-color: #22c55e;
                color: white;
            }
            
            .doubt {
                background-color: #eab308;
                color: white;
            }
            
            .unanswered {
                background-color: #f3f4f6;
                color: #374151;
            }
            
            .current {
                border: 3px solid #3b82f6;
            }
            
            .timer-warning {
                animation: pulse 1s infinite;
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.6; }
            }
            
            .loading-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            }
                        
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            
            .snap-x {
                scroll-snap-type: x mandatory;
            }
            
            .snap-start {
                scroll-snap-align: start;
            }
            
            .snap-mandatory {
                scroll-behavior: smooth;
            }
            /* ... style lainnya ... */

            /* Pastikan SweetAlert selalu di atas Loading Overlay */
            .swal2-container {
                z-index: 99999 !important;
            }
            
            /* Mencegah body bergeser saat popup muncul */
            body.swal2-shown > [aria-hidden="true"] {
                transition: 0.1s filter;
                filter: blur(3px); /* Efek blur keren di background saat popup muncul */
            }
            /* Reset Margin */
            body {
                margin: 0;
                padding: 0;
                top: 0; 
                left: 0;
                width: 100%;
                min-height: 100vh;
                background-color:#1e3a8a;
                overflow-x: hidden; 
            
            
                /* Mematikan pull-to-refresh di Chrome & Safari Mobile */
                overscroll-behavior-y: contain; 
                /* Mencegah pemilihan teks (opsional untuk keamanan) */
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                box-sizing: border-box;
            }

            .header-waves {
                position: absolute;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background: linear-gradient(60deg, #0f172a 0%, #1e3a8a 100%); /* Warna Laut Dalam */
                color: white;
                z-index: 0; /* Di belakang layar */
                overflow: hidden;
            }

            .waves {
                position: absolute;
                bottom: 0;
                width: 100%;
                height: 45vh; /* Tinggi ombak 15% dari layar */
                min-height: 100px;
                max-height: 200px;
            }

            /* Animasi Gerakan Ombak */
            .parallax > use {
                animation: move-forever 25s cubic-bezier(.55,.5,.45,.5) infinite;
            }
            .parallax > use:nth-child(1) {
                animation-delay: -2s;
                animation-duration: 7s;
                fill: rgba(59, 130, 246, 0.7); /* Biru Terang Transparan */
            }
            .parallax > use:nth-child(2) {
                animation-delay: -3s;
                animation-duration: 10s;
                fill: rgba(37, 99, 235, 0.5); /* Biru Sedang Transparan */
            }
            .parallax > use:nth-child(3) {
                animation-delay: -4s;
                animation-duration: 13s;
                fill: rgba(29, 78, 216, 0.3); /* Biru Gelap Transparan */
            }
            .parallax > use:nth-child(4) {
                animation-delay: -5s;
                animation-duration: 20s;
                fill: #1e3a8a; /* Warna Dasar Ombak (Biru Laut Malam) */
            }
            
            @keyframes move-forever {
                0% { transform: translate3d(-90px,0,0); }
                100% { transform: translate3d(85px,0,0); }
            }

            /* Responsif untuk HP (Ombak tetap terlihat proporsional) */
            @media (max-width: 768px) {
                .waves { height: 85px; min-height: 85px; }
            }
            @view-transition { navigation: auto; }
            #app {
                width: 100%;
                /* Gunakan min-height: 100vh agar responsif menyesuaikan layar mobile */
                min-height: 100vh; 
                
                /* Gunakan flexbox agar isi di dalamnya (header, konten) tersusun rapi */
                display: flex;
                flex-direction: column;
                
                /* Menerapkan smooth scrolling untuk perangkat sentuh */
                -webkit-overflow-scrolling: touch;
                
                /* Properti bawaan Anda sebelumnya */
                position: relative;
                z-index: 10;
            }
        </style>
    </head>
    <body class="min-h-screen">
        <div class="header-waves">
            <div class="inner-header flex"></div>
            <div>
                <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
                    <defs>
                        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
                    </defs>
                    <g class="parallax">
                        <use xlink:href="#gentle-wave" x="48" y="0" fill="rgba(255,255,255,0.7" />
                        <use xlink:href="#gentle-wave" x="48" y="3" fill="rgba(255,255,255,0.5)" />
                        <use xlink:href="#gentle-wave" x="48" y="5" fill="rgba(255,255,255,0.3)" />
                        <use xlink:href="#gentle-wave" x="48" y="7" fill="#fff" />
                    </g>
                </svg>
            </div>
        </div>
        <div id="app" class="min-h-screen w-full flex flex-col" style="position: relative; z-index: 10;"></div>
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="text-center">
            </div>
        </div>
        <script>
            if ('virtualKeyboard' in navigator) {
                // Memaksa keyboard menjadi overlay (terapung)
                navigator.virtualKeyboard.overlaysContent = true;
            }
            // Konfigurasi Wake Lock (Penahan Layar)
                let wakeLock = null;

                async function requestWakeLock() {
                    try {
                        if ('wakeLock' in navigator) {
                            wakeLock = await navigator.wakeLock.request('screen');
                            console.log('Layar ditahan agar tetap menyala.');
                        }
                    } catch (err) {
                        console.error('Fitur Wake Lock gagal/tidak didukung:', err);
                    }
                }

                // Menyalakan kembali penahan layar jika siswa sempat pindah tab lalu kembali lagi
                document.addEventListener('visibilitychange', () => {
                    if (wakeLock !== null && document.visibilityState === 'visible') {
                        requestWakeLock();
                    }
                });

            // Catatan penting: Wake lock otomatis terlepas oleh browser jika siswa 
            // meminimalkan browser atau pindah tab. Kita harus menyalakannya kembali saat mereka kembali.
            document.addEventListener('visibilitychange', () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    requestWakeLock();
                }
            });
            // ============================================
            // KONFIGURASI GOOGLE SHEETS
            // ============================================
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz7GPdsc6CXcY31ZSA1XjnL7NobL1mDYkVg-ewMptXMqCXm001ri7a9mgNBQcG52Bgq/exec';
            
            const defaultConfig = {
                app_title: "",
                school_name: "SMPN 11 TANGERANG",
                welcome_text: "",
                login_button_text: "Masuk",
                primary_color: "#3b82f6",
                secondary_color: "#1e40af",
                background_color: "#dbeafe",
                text_color: "#1f2937",
                button_color: "#2563eb",
                font_family: "Arial",
                font_size: 16
            };

            // 1. SETUP DATABASE
            const MY_SUPABASE_URL = 'https://wvpuqjbogceftyoxzsiu.supabase.co'; 
            const MY_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2cHVxamJvZ2NlZnR5b3h6c2l1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NDg5MjQsImV4cCI6MjA4MzQyNDkyNH0.3K9iuFsgvvFLKG-JbG1P2oWqU7JnoZxBZe9aNiHhtT4'; // <-- Masukkan Key Anon/Public kamu

            // Variabel ini harus diluar fungsi agar bisa dibaca semua orang
            let dbClient = null;

            // Inisialisasi Database
            if (typeof window.supabase !== 'undefined') {
                if (!window.supabaseInstance) {
                    window.supabaseInstance = window.supabase.createClient(MY_SUPABASE_URL, MY_SUPABASE_KEY);
                }
                dbClient = window.supabaseInstance;
            } else {
                console.error("Library Supabase belum terpasang di <head>!");
            }

            // ============================================
            // GLOBAL VARIABLES
            // ============================================
            let currentUser = null;
            let currentExam = null;
            let examQuestions = [];
            let studentAnswers = {};
            let doubtQuestions = new Set();
            let currentQuestionIndex = 0;
            let examTimer = null;
            let remainingTime = 0;
            let violationCount = 0;
            let examSubmitted = false;
            let isRefreshing = false; // Tambahkan ini
            let allUsers = [];
            let allQuestions = [];
            let allExamResults = [];
            let examSettings = {
                exam_duration: 60,
                shuffle_questions: false,
                shuffle_answers: false,
                show_score: true,
                max_questions: 0,
                limit_one_attempt: false,
                active_subjects: [] // Array of active exam subjects with schedules
            };
            let currentAdminTab = 'dashboard'; // Default tab admin
            let currentGuruTab = 'dashboard';  // Default tab guru
            let filterState = {
                class: "",      // Menyimpan kelas yang dipilih
                subject: "",     // Menyimpan mapel yang dipilih
                sortBy: "time_desc" // Default: Waktu Terbaru
            };
            
            // Load minimum waktu submit dari localStorage
            let minTimeToSubmit = parseInt(localStorage.getItem('minTimeToSubmit') || '0');
            let hasSubmitted = false; // Status apakah siswa sudah submit ujian
            
            const SUBJECTS = [
                "SMT GANJIL - UP BAB I",
                "SMT GANJIL - UP BAB II",
                "SMT GANJIL - UP BAB III",
                "UP TENGAH SEMESTER 1",
                "SMT GANJIL - UP BAB IV",
                "SMT GANJIL - UP BAB V",
                "ULANGAN HARIAN I SMT1",
                "ULANGAN HARIAN II SMT1",
                "SMT GENAP - UP BAB I",
                "SMT GENAP - UP BAB II",
                "UP TENGAH SEMESTER 2",
                "SMT GENAP - UP BAB III",
                "SMT GENAP - UP BAB IV",
                "ULANGAN HARIAN I SMT2",
                "ULANGAN HARIAN II SMT2"
            ];
            
            // ============================================
            // LOADING FUNCTIONS
            // ============================================
            // FUNGSI HELPER FILTER
            // --- 2. FUNGSI UPDATE FILTER ---
            // Fungsi ini menggantikan filterResults() yang lama
            function updateFilter(key, value) {
                filterState[key] = value;
                renderResultsSection(); // Render ulang tampilan dengan data yang difilter
            }

            async function compressImage(base64Str, maxWidth = 800, quality = 0.7) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = base64Str;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Hitung rasio agar gambar tidak penyet
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Ubah kembali ke Base64 dengan format JPEG (lebih ringan dari PNG)
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedBase64);
                    };
                });
            }
            
            // --- PILIHAN 9: 3D CUBE LOGIC ---

            function showLoading() {
                const overlay = document.getElementById('loadingOverlay');
                if (!overlay) return;
                overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                

                if (!overlay.innerHTML.includes('cube-loader')) {
                    overlay.innerHTML = `
                        <style>
                            .cube-loader {
                                width: 70px; height: 70px; margin: 0 auto 30px auto;
                                transform-style: preserve-3d;
                                animation: rotateCube 2.5s infinite linear;
                            }
                            .cube-face {
                                position: absolute; width: 70px; height: 70px;
                                border: 2px solid #3b82f6;
                                background: rgba(59, 130, 246, 0.15);
                                box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
                            }
                            .front  { transform: translateZ(35px); }
                            .back   { transform: rotateY(180deg) translateZ(35px); }
                            .right  { transform: rotateY(90deg) translateZ(35px); }
                            .left   { transform: rotateY(-90deg) translateZ(35px); }
                            .top    { transform: rotateX(90deg) translateZ(35px); }
                            .bottom { transform: rotateX(-90deg) translateZ(35px); }
                            
                            @keyframes rotateCube {
                                0% { transform: rotateX(0deg) rotateY(0deg); }
                                100% { transform: rotateX(360deg) rotateY(360deg); }
                            }
                            
                            .loading-text {
                                text-align: center; color: white; font-family: sans-serif; 
                                letter-spacing: 2px; font-size: 0.9rem;
                            }
                        </style>
                        
                        <div>
                            <div class="cube-loader">
                                <div class="cube-face front"></div>
                                <div class="cube-face back"></div>
                                <div class="cube-face right"></div>
                                <div class="cube-face left"></div>
                                <div class="cube-face top"></div>
                                <div class="cube-face bottom"></div>
                            </div>
                            <div class="loading-text">MEMUA DATA...</div>
                        </div>
                    `;
                }
                overlay.style.display = 'flex';
            }

            function hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) overlay.style.display = 'none';
            }

            // Fungsi ini tugasnya cuma satu: Mengembalikan data yang sudah difilter & disortir
            function getProcessedData() {
                // 1. FILTER
                let filtered = allExamResults.filter(item => {
                    const selectedClass = String(filterState.class || "").trim();
                    const itemClass = String(item.student_class || "").trim();
                    const selectedSubject = String(filterState.subject || "").trim();
                    const itemSubject = String(item.exam_subject || "").trim();

                    const matchClass = selectedClass === "" || itemClass === selectedClass;
                    const matchSubject = selectedSubject === "" || itemSubject === selectedSubject;
                    return matchClass && matchSubject;
                });

                // 2. SORTING
                filtered.sort((a, b) => {
                    switch (filterState.sortBy) {
                        case 'score_desc': return Number(b.final_score) - Number(a.final_score);
                        case 'score_asc': return Number(a.final_score) - Number(b.final_score);
                        case 'name_asc': return a.student_name.localeCompare(b.student_name);
                        case 'name_desc': return b.student_name.localeCompare(a.student_name);
                        case 'time_desc': default: return new Date(b.exam_time || 0) - new Date(a.exam_time || 0);
                    }
                });

                return filtered;
            }
            
            // ============================================
            // GOOGLE SHEETS API FUNCTIONS
            // ============================================
            async function loadInitialData() {
                try {
                    showLoading();
                    // Panggil action 'getLoginData' (sesuai script baru)
                    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getLoginData`);
                    const data = await response.json();
                    
                    if (data.success) {
                        allUsers = data.users || [];
                        
                        // Load settings
                        if (data.settings) {
                            examSettings.exam_duration = data.settings.exam_duration || examSettings.exam_duration;
                            examSettings.shuffle_questions = data.settings.shuffle_questions || false;
                            examSettings.shuffle_answers = data.settings.shuffle_answers || false;
                            examSettings.show_score = data.settings.show_score !== undefined ? data.settings.show_score : true;
                            examSettings.max_questions = data.settings.max_questions || 0;
                            examSettings.limit_one_attempt = data.settings.limit_one_attempt || false;
                            
                            if (data.settings.active_subjects) {
                                try {
                                    examSettings.active_subjects = typeof data.settings.active_subjects === 'string' 
                                        ? JSON.parse(data.settings.active_subjects) 
                                        : data.settings.active_subjects;
                                } catch {
                                    examSettings.active_subjects = [];
                                }
                            }
                        }
                        return true;
                    } else {
                        showToast('Gagal memuat user: ' + data.message, 'error');
                        return false;
                    }
                } catch (error) {
                    showToast('Gagal terhubung ke server', 'error');
                    return false;
                } finally {
                    hideLoading();
                }
            }

            // 2. LOAD BERAT: Soal & Nilai (Dipanggil SETELAH login berhasil)
            async function loadExamData(silent = false) {
                try {
                    // Hanya tampilkan loading jika silent bernilai false
                    if (!silent) showLoading();
                    // Panggil action 'getExamData' (sesuai script baru)
                    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getExamData`);
                    const data = await response.json();
                    
                    if (data.success) {
                        allQuestions = data.questions || [];
                        
                        // Logika filter role
                        const userRole = currentUser ? currentUser.role : null;
                        const fullResults = data.examResults || [];
                        if (userRole === 'admin' || userRole === 'guru') {
                            allExamResults = data.examResults || [];
                        } else {
                            
                            if (currentUser) {
                                allExamResults = fullResults.filter(r => r.student_name === currentUser.name);
                            } else {
                            allExamResults = [];
                            }
                        }
                        return true;
                    } else {
                        showToast('Gagal memuat soal: ' + data.message, 'error');
                        return false;
                    }
                } catch (error) {
                    showToast('Gagal memuat data ujian', 'error');
                    return false;
                } finally {
                    if (!silent) hideLoading();
                }
            }         

            // ============================================================
            // 1. BAGIAN SISWA (LAPOR)
            // ============================================================

            async function laporKeAdmin() {
                // Cek koneksi & user login
                if (!dbClient || !currentUser) return;

                if (currentUser.class === 'admin' || currentUser.class === 'guru') {
                    return; // Fungsi langsung dihentikan di sini, tidak ada data yang dikirim
                }

                let statusSiswa = "Mengerjakan";
                if (document.hidden) statusSiswa = "MENCURIGAKAN (Minimize)";
                if (typeof hasSubmitted !== 'undefined' && hasSubmitted) statusSiswa = "Selesai";

                let progressCount = 0;
                if (typeof studentAnswers !== 'undefined') {
                    progressCount = Object.keys(studentAnswers).length;
                }

                // Ambil Nama Mapel (Dengan pengecekan aman)
                let namaMapel = "Ujian"; 
                if (typeof currentExam !== 'undefined' && currentExam && currentExam.subject) {
                    namaMapel = currentExam.subject;
                }

                const payload = {
                    id: currentUser.username, // Sesuaikan dengan kolom PK di database (nisn/id)
                    nama: currentUser.name,
                    kelas: currentUser.class,
                    mapel: namaMapel,
                    status: statusSiswa,
                    progress: progressCount + " Soal Terjawab",
                    last_update: new Date().toLocaleTimeString('id-ID') // Penting untuk kolom Last Update di Admin
                };

                // Kirim ke Database
                const { error } = await dbClient
                    .from('monitoring')
                    .upsert(payload, { onConflict: 'id' }); 

                if (error) console.error("Gagal lapor:", error.message);
            }

            // Pemicu Laporan Siswa
            function mulaiPelaporanSiswa() {
                console.log("Sistem pelaporan siswa aktif.");
                
                // 1. Lapor Rutin (WAJIB DIAKTIFKAN BIAR PROGRESS JALAN)
                // Lapor setiap 5 detik agar Admin tau siswa masih hidup/mengerjakan
                setInterval(laporKeAdmin, 5000); 
                
                // 2. Lapor Instan saat Pindah Tab (Anti-Curang)
                document.addEventListener("visibilitychange", laporKeAdmin);
            }


            // ============================================================
            // 2. BAGIAN ADMIN (MONITORING AUTO-REFRESH)
            // ============================================================

            // Variabel timer refresh admin
            let monitorInterval = null;

            async function bukaMonitoring() {
                console.log("ðŸš€ Membuka monitoring (Mode Auto-Refresh)...");
                
                // Cek Database
                if (!dbClient) {
                    alert("Database belum siap. Coba refresh halaman.");
                    return;
                }

                // Tampilkan Panel
                const panel = document.getElementById('monitorPanel');
                if (panel) panel.classList.remove('hidden');

                const loadingText = document.getElementById('loadingText');
                if (loadingText) {
                    loadingText.style.display = 'block';
                    loadingText.innerText = "Menghubungkan...";
                    loadingText.style.color = "green";
                }

                // A. Ambil Data Awal (Langsung)
                await ambilDataTerbaru();

                // B. Aktifkan Loop Auto-Refresh (Setiap 3 Detik)
                if (monitorInterval) clearInterval(monitorInterval);
                
                monitorInterval = setInterval(async () => {
                    await ambilDataTerbaru();
                }, 3000); 
            }

            // Fungsi Fetch Data ke Supabase
            async function ambilDataTerbaru() {
                const { data, error } = await dbClient
                    .from('monitoring')
                    .select('*')
                    .order('last_update', { ascending: false }); // Yang baru update di paling atas

                if (error) {
                    console.error("âŒ Gagal refresh:", error.message);
                } else {
                    // Update teks status
                    const loadingText = document.getElementById('loadingText');
                    if (loadingText) loadingText.innerText = `Update: ${new Date().toLocaleTimeString()}`;

                    // Masukkan data ke tabel
                    if (data) {
                        data.forEach(siswa => {
                            updateBarisTabel(siswa);
                        });
                    }
                }
            }

            // Fungsi Render HTML Baris Tabel
            function updateBarisTabel(data) {
                const tbody = document.getElementById('monitorTableBody');
                if (!tbody) return;

                // Pastikan punya ID
                const uniqueId = data.id; 
                if (!uniqueId) return;

                const rowId = 'row-' + uniqueId;
                let row = document.getElementById(rowId);

                // Logika Warna Status
                let statusClass = "text-green-600 font-bold";
                let bgClass = "bg-white hover:bg-gray-50";
                
                const statusText = data.status || "-";
                if (statusText.includes("MENCURIGAKAN")) {
                    statusClass = "text-red-600 font-bold animate-pulse";
                    bgClass = "bg-red-50";
                } else if (statusText === "Selesai") {
                    statusClass = "text-blue-600 font-bold";
                    bgClass = "bg-blue-50";
                }
                
                const mapelSiswa = data.mapel || "-";
                let waktuUpdate = "Barusan";

                if (data.last_update) {
                    // Jika formatnya ISO (ada huruf T), kita ubah jadi jam lokal Indonesia
                    if (data.last_update.includes('T')) {
                        waktuUpdate = new Date(data.last_update).toLocaleTimeString('id-ID');
                    } else {
                        // Jika formatnya sudah teks biasa (Solusi 1), langsung tampilkan
                        waktuUpdate = data.last_update;
                    }
                }

                // Template HTML
                const htmlContent = `
                    <td class="p-3 border-b font-medium text-gray-800">${data.nama || "No Name"}</td>
                    <td class="p-3 border-b text-gray-600">${data.kelas || "-"}</td>
                    <td class="p-3 border-b text-blue-600 font-medium text-sm">${mapelSiswa}</td>
                    <td class="p-3 border-b text-center ${statusClass}">${statusText}</td>
                    <td class="p-3 border-b text-center font-mono text-sm">${data.progress || "0"}</td>
                    <td class="p-3 border-b text-right text-xs text-gray-400">${waktuUpdate}</td>
                `;

                // Cek apakah baris sudah ada?
                if (row) {
                    // Update hanya jika konten berubah (biar hemat resource browser)
                    if (row.innerHTML !== htmlContent) {
                        row.innerHTML = htmlContent;
                        row.className = bgClass;
                        // Efek kedip kuning
                        row.style.backgroundColor = "#fffbeb";
                        setTimeout(() => { row.style.backgroundColor = ""; }, 500);
                    }
                } else {
                    // Buat baris baru
                    const newRow = document.createElement('tr');
                    newRow.id = rowId;
                    newRow.className = bgClass;
                    newRow.innerHTML = htmlContent;
                    tbody.prepend(newRow);
                }
            }
            
            async function saveUserToSheet(userData) {
                try {
                    showLoading();
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'addUser',
                            ...userData
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        await loadAllData();
                        return true;
                    } else {
                        showToast('Gagal menyimpan user: ' + result.message, 'error');
                        return false;
                    }
                } catch (error) {
                    showToast('Gagal menyimpan user', 'error');
                    return false;
                } finally {
                    hideLoading();
                }
            }
            
            async function deleteUserFromSheet(userId) {
                try {
                    showLoading();
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'deleteUser',
                            id: userId
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        await loadAllData();
                        return true;
                    } else {
                        showToast('Gagal menghapus user: ' + result.message, 'error');
                        return false;
                    }
                } catch (error) {
                    showToast('Gagal menghapus user', 'error');
                    return false;
                } finally {
                    hideLoading();
                }
            }
            
            async function saveQuestionToSheet(questionData) {
                try {
                    showLoading();
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'addQuestion',
                            ...questionData
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        await loadExamData();
                        if (currentUser.role === 'admin') {
                            renderQuestionsSection();
                        } else if (currentUser.role === 'guru') {
                            renderGuruQuestionsSection();
                        }
                        showToast('Soal berhasil disimpan', 'success');
                        return true;
                    } else {
                        showToast('Gagal menyimpan soal: ' + result.message, 'error');
                        return false;
                    }
                } catch (error) {
                    showToast('Gagal menyimpan soal', 'error');
                    return false;
                } finally {
                    hideLoading();
                }
            }
            
            async function deleteQuestionFromSheet(questionId) {
                try {
                    showLoading();
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'deleteQuestion',
                            id: questionId
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        await loadExamData();
                        if (currentUser.role === 'admin') {
                            renderQuestionsSection();
                        } else if (currentUser.role === 'guru') {
                            renderGuruQuestionsSection();
                        }
                        showToast('Soal berhasil dihapus', 'success');
                        return true;
                    } else {
                        showToast('Gagal menghapus soal: ' + result.message, 'error');
                        return false;
                    }
                } catch (error) {
                    showToast('Gagal menghapus soal', 'error');
                    return false;
                } finally {
                    hideLoading();
                }
            }
            
            async function saveExamResultToSheet(examData, retries = 3) {
                for (let i = 0; i < retries; i++) {
                    try {
                        showLoading();
                        const response = await fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'addExamResult',
                                ...examData
                            })
                        });
                
                        const result = await response.json();
                        if (result.success) {
                            return true; // Berhasil terkirim
                        }
                
                        // Jika server merespon tapi sukses false, log errornya
                    } catch (error) {
                    } finally {
                        hideLoading();
                    }
            
                    // Tunggu sebentar sebelum mencoba lagi (exponential backoff)
                    if (i < retries - 1) {
                        const waitTime = (i + 1) * 2000; // 2s, 4s...
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    }
                }
                return false; // Gagal total setelah semua percobaan
            }
            
            async function saveSettingsToSheet(settings) {
                try {
                    showLoading();
                    const updatedSettings = {
                        ...examSettings, // Mengambil data lama (termasuk active_subjects)
                        ...settings,      // Menimpa dengan data baru dari form
                        active_subjects: examSettings.active_subjects // Daftar jadwal terbaru
                    };
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'updateSettings',
                            ...settings
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        await loadInitialData();
                        showToast('Pengaturan berhasil disimpan', 'success');
                        return true;
                    } else {
                        showToast('Gagal menyimpan pengaturan: ' + result.message, 'error');
                        return false;
                    }
                } catch (error) {
                    showToast('Gagal menyimpan pengaturan', 'error');
                    return false;
                } finally {
                    hideLoading();
                }
            }

            // ============================================
            // INITIALIZATION
            // ============================================

            // Mendeteksi jika user menekan tombol refresh atau menutup halaman
            window.onbeforeunload = function() {
                isRefreshing = true;
            };

            function activateFullscreen() {
                let element = document.documentElement; // Mengambil seluruh halaman
                if (element.requestFullscreen) {
                    element.requestFullscreen().catch(err => {
                    });
                } else if (element.webkitRequestFullscreen) { /* Safari & iOS */
                    element.webkitRequestFullscreen();
                } else if (element.mozRequestFullScreen) { /* Firefox */
                    element.mozRequestFullScreen();
                } else if (element.msRequestFullscreen) { /* IE11 */
                    element.msRequestFullscreen();
                }
            }

            async function init() {
                isRefreshing = false;

                // Deteksi klik kanan (mencoba buka menu context)
                document.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                }, false);
                // Mencegah tombol F12, Ctrl+Shift+I, Ctrl+U
                document.onkeydown = function(e) {
                    if (e.keyCode == 123 || 
                        (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) || 
                        (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0))) {
                        return false;
                    }
                }
                // 1. Pastikan data dari server sudah dimuat sebelum mengecek status login
                const dataLoaded = await loadInitialData();
        
                // 2. Gunakan localStorage agar lebih persisten saat refresh
                const savedUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
                const savedExam = localStorage.getItem('currentExam');
        
                if (savedUser && savedExam && dataLoaded) {
                    currentUser = JSON.parse(savedUser);

                    // TAMBAHAN PENTING:
                    // Karena user refresh halaman saat ujian, kita WAJIB load soal sekarang
                    const examLoaded = await loadExamData();
                    if (!examLoaded) {
                        alert("Gagal mengembalikan sesi ujian. Silakan login ulang.");
                        localStorage.clear();
                        renderLoginPage();
                        return;
                    }
                    currentExam = JSON.parse(savedExam);
            
                    // Load data jawaban dan state lainnya
                    const savedAnswers = localStorage.getItem('studentAnswers');
                    const savedDoubt = localStorage.getItem('doubtQuestions') || sessionStorage.getItem('doubtQuestions');
                    const savedIndex = localStorage.getItem('currentQuestionIndex') || sessionStorage.getItem('currentQuestionIndex');
                    const savedTime = localStorage.getItem('remainingTime') || sessionStorage.getItem('remainingTime');
                    const savedViolations = localStorage.getItem('violationCount') || sessionStorage.getItem('violationCount');
                    // 2. VALIDASI KRUSIAL: Cek apakah mata pelajaran ini benar-benar punya soal
                    const subjectQuestions = allQuestions.filter(q => q.subject === currentExam.subject);
            
                    if (savedAnswers) studentAnswers = JSON.parse(savedAnswers);
                    if (savedDoubt) doubtQuestions = new Set(JSON.parse(savedDoubt));
                    if (savedIndex) currentQuestionIndex = parseInt(savedIndex);
                    if (savedTime) remainingTime = parseInt(savedTime);
                    if (savedViolations) violationCount = parseInt(savedViolations);
                    if (subjectQuestions.length === 0) {
                        // Jika setelah refresh ternyata soal tidak ada/belum tersedia
                        alert("Maaf, soal untuk mata pelajaran ini belum tersedia.");

                        // Bersihkan data ujian yang salah dari storage
                        localStorage.removeItem('currentExam');
                        sessionStorage.removeItem('currentExam');

                        // Kembalikan ke halaman login atau dashboard
                        renderLoginPage(); 
                        return;
                    };     
            
                    await loadExamQuestions();
                    renderExamPage();
                } else {
                    // Jika tidak ada data ujian aktif, pastikan variabel dibersihkan dan tampilkan login
                    currentUser = null;
                    currentExam = null;
                    renderLoginPage();
                }
            }

            // ============================================
            // LOGIN PAGE
            // ============================================
            function renderLoginPage() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                const textColor = config.text_color || defaultConfig.text_color;

                // Ganti URL ini dengan gambar latar belakang pilihan Anda
                //const bgImage = "https://i.ibb.co.com/vvgwB7rL/yo.png";
                
                document.getElementById('app').innerHTML = `
                    <div id="login-animasi" class="min-h-screen flex items-center justify-center p-4">
                        <div class="w-full max-w-md">
                            <div class="glass-panel p-8 shadow-2xl">
                                <div class="text-center mb-8">
                                    <h1 class="font-bold mb-3" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 2}px; color: white;">Selamat Datang</h1>
                                    <p style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px; color: rgba(255,255,255,0.8);">Silahkan Login untuk memulai ujian</p>
                                </div>
                        
                                <form id="loginForm" class="space-y-4">
                                    <div>
                                        <label class="block font-medium mb-2 text-white" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Username</label>
                                        <input type="text" id="username" required 
                                            class="glass-input w-full px-4 py-3 rounded-lg focus:outline-none transition"
                                            style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;"
                                            placeholder="Masukkan username">
                                    </div>
                            
                                    <div class="relative">
                                    <label class="block font-medium mb-2 text-white" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Password</label>
                                    <div class="relative">
                                        <input type="password" id="password" required 
                                            class="glass-input w-full px-4 py-3 rounded-lg focus:outline-none transition pr-10"
                                            style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;"
                                            placeholder="Masukkan password">
                                        <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center text-white opacity-70 hover:opacity-100">
                                            <span id="eyeIcon">ðŸ™ˆ</span>
                                        </button>
                                    </div>
                                </div>
                            
                                    <div id="subjectSelect" style="display: none;">
                                        <label class="block font-medium mb-2 text-white" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Pilih Ujian</label>
                                        <select id="subject" 
                                            class="glass-input w-full px-4 py-3 rounded-lg focus:outline-none transition appearance-none"
                                            style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: black;">
                                            <option value="">Pilih Mata Pelajaran</option>
                                            ${SUBJECTS.map(s => `<option value="${s}">${s}</option>`).join('')}
                                        </select>
                                    </div>
                            
                                    <div id="errorMessage" class="text-red-300 text-center hidden font-bold" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;"></div>

                                    <button type="submit" id="loginBtn"
                                        class="w-full py-3 rounded-lg text-white font-semibold hover:scale-[1.02] transition-transform shadow-lg"
                                        style="background: linear-gradient(135deg, ${primaryColor} 0%, ${config.secondary_color || defaultConfig.secondary_color} 100%); font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                                        ${config.login_button_text || defaultConfig.login_button_text}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                // --- MULAI KODE ANIMASI VANTA JS ---
                // Cek jika ada animasi sebelumnya, hapus dulu agar tidak berat
                if (window.vantaEffect) window.vantaEffect.destroy();
                
                document.getElementById('username').addEventListener('input', checkUserRole);
                document.getElementById('loginForm').addEventListener('submit', handleLogin);

                // Logika untuk Show/Hide Password
                const passwordInput = document.getElementById('password');
                const toggleButton = document.getElementById('togglePassword');
                const eyeIcon = document.getElementById('eyeIcon');

                toggleButton.addEventListener('click', function () {
                    // Cek tipe input saat ini
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    
                    // Ubah icon (Opsional: Anda bisa mengganti emoji-nya)
                    eyeIcon.textContent = type === 'password' ? 'ðŸ™ˆ' : 'ðŸµ';
                });
            }

            function checkUserRole() {
                const username = document.getElementById('username').value.trim();
                const user = allUsers.find(u => u.username === username);
                
                if (user && user.role === 'siswa') {
                    document.getElementById('subjectSelect').style.display = 'block';
                    // Filter hanya mata pelajaran yang aktif
                    const subjectSelect = document.getElementById('subject');
                    subjectSelect.innerHTML = '<option value="">Pilih Ujian</option>';
                    
                    const activeSubjects = getActiveSubjects();
                    
                    if (activeSubjects.length === 0) {
                        subjectSelect.innerHTML += '<option value="" disabled>Tidak ada ujian yang aktif saat ini</option>';
                    } else {
                        activeSubjects.forEach(subject => {
                            subjectSelect.innerHTML += `<option value="${subject}">${subject}</option>`;
                        });
                    }
                } else {
                    document.getElementById('subjectSelect').style.display = 'none';
                }
            }
            
            function getActiveSubjects() {
                if (!examSettings.active_subjects || examSettings.active_subjects.length === 0) {
                    return SUBJECTS; // Jika tidak ada pengaturan, semua mapel bisa diakses
                }
                
                const now = new Date();
                const activeSubjects = [];
                
                examSettings.active_subjects.forEach(item => {
                    if (!item.start_time || !item.end_time) {
                        // Jika tidak ada jadwal, cek status aktif manual
                        if (item.is_active) {
                            activeSubjects.push(item.subject);
                        }
                    } else {
                        // Cek apakah sekarang dalam rentang waktu ujian
                        const startTime = new Date(item.start_time);
                        const endTime = new Date(item.end_time);
                        
                        if (now >= startTime && now <= endTime) {
                            activeSubjects.push(item.subject);
                        }
                    }
                });
                
                return activeSubjects;
            }

            async function handleLogin(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                const subject = document.getElementById('subject').value;
                
                const user = allUsers.find(u => u.username === username && u.password === password);
                
                if (!user) {
                    showError('Username atau password salah!');
                    return;
                }
                
                if (user.role === 'siswa' && !subject) {
                    showError('Silakan pilih mata pelajaran!');
                    return;
                }
                
                // Validasi apakah mata pelajaran aktif
                if (user.role === 'siswa') {
                    const activeSubjects = getActiveSubjects();
                    if (activeSubjects.length > 0 && !activeSubjects.includes(subject)) {
                        showError('Mata pelajaran ini tidak sedang dalam jadwal ujian!');
                        return;
                    }
                }
                
                currentUser = user;
                sessionStorage.setItem('currentUser', JSON.stringify(user));
                localStorage.setItem('currentUser', JSON.stringify(user)); // Tambahkan ini

                // --- TAMBAHAN BARU DI SINI ---
                // Karena login sukses, sekarang saatnya download soal yang berat
                const examDataLoaded = await loadExamData();
                if (user.role === 'siswa' && examSettings.limit_one_attempt) {
                    // Cek apakah ada hasil ujian untuk user ini di mapel yang dipilih
                    const hasTakenExam = allExamResults.some(result => 
                        result.student_name === user.name && 
                        result.exam_subject === subject
                    );

                    if (hasTakenExam) {
                        hideLoading();
                        if (typeof Swal !== 'undefined') {
                            await Swal.fire({
                                icon: 'warning',
                                title: 'Akses Ditolak',
                                text: 'Anda sudah mengerjakan ujian ini. Kesempatan hanya 1 kali.',
                                confirmButtonColor: '#d33',
                                confirmButtonText: 'Kembali',
                                heightAuto: false, //Mencegah layar "terangkat" (putih)
                                backdrop: `
                                    rgba(0,0,123,0.4)
                                    left top
                                    no-repeat
                                `, // Membuat background belakang agak gelap transparan
                                allowOutsideClick: false,
                                allowEscapeKey: false
                            });
                        } else {
                            alert("Anda sudah mengerjakan ujian ini!");
                        }
                        // Bersihkan sesi agar tidak lanjut
                        currentUser = null;
                        sessionStorage.removeItem('currentUser');
                        localStorage.removeItem('currentUser');
                        document.getElementById('loginForm').reset();
                        renderLoginPage();
                        return;
                    }
                }
                if (!examDataLoaded) {
                    showError('Gagal memuat data soal. Coba lagi.');
                    return;
                }
                // TAMBAHKAN KODE INI DI SINI
                if (user.role === 'siswa') {
                activateFullscreen();
                }
                
                if (user.role === 'admin') {
                    renderAdminDashboard();
                } else if (user.role === 'guru') {
                    e.subject = user.subject;
                    e.question_class = user.class;
                    renderGuruDashboard();
                } else {
                    currentExam = { subject: subject };
                    sessionStorage.setItem('currentExam', JSON.stringify(currentExam));
                    localStorage.setItem('currentExam', JSON.stringify(currentExam)); // Tambahkan ini
                    
                    const gradeLevel = user.class.charAt(0);
                    const availableQuestions = allQuestions.filter(q => 
                        q.question_class === gradeLevel && 
                        q.subject === subject
                    );
                    
                    if (availableQuestions.length === 0) {
                        renderNoQuestionsPage();
                        return;
                    }
                    
                    await loadExamQuestions();
                    if (typeof mulaiPelaporanSiswa === "function") {
                        mulaiPelaporanSiswa();
                    }
                    renderExamPage();
                }
            }

            function showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                setTimeout(() => errorDiv.classList.add('hidden'), 3000);
            }

            // ============================================
            // EXAM FUNCTIONS
            // ============================================
            async function loadExamQuestions() {
                const gradeLevel = currentUser.class.charAt(0);
                
                let questions = allQuestions.filter(q => 
                    q.question_class === gradeLevel && 
                    q.subject === currentExam.subject
                );
                
                if (examSettings.shuffle_questions) {
                    questions = shuffleArray(questions);
                }
                
                // Batasi jumlah soal jika max_questions > 0
                if (examSettings.max_questions > 0 && questions.length > examSettings.max_questions) {
                    questions = questions.slice(0, examSettings.max_questions);
                }
                
                examQuestions = questions.map(q => {
                    let options = [];
                    try {
                        options = JSON.parse(q.options || '[]');
                    } catch {
                        options = [];
                    }
                    
                    if (examSettings.shuffle_answers && q.question_type === 'pilihan_ganda') {
                        options = shuffleArray(options);
                    }
                    
                    return { ...q, options };
                });
                
                if (!remainingTime) {
                    remainingTime = examSettings.exam_duration * 60;
                }
            }

            function shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }

            function renderNoQuestionsPage() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                const textColor = config.text_color || defaultConfig.text_color;
                const backgroundColor = config.background_color || defaultConfig.background_color;
                
                document.getElementById('app').innerHTML = `
                    <div class="min-h-full flex items-center justify-center p-4" style="background: linear-gradient(135deg, ${backgroundColor} 0%, #bfdbfe 100%);">
                        <div class="max-w-md w-full bg-white rounded-2xl shadow-custom p-8 text-center">
                            <div class="mb-6">
                                <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-yellow-100 flex items-center justify-center">
                                    <span class="text-6xl">âš ï¸</span>
                                </div>
                                <h1 class="font-bold mb-3" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.75}px; color: ${textColor};">Soal Belum Tersedia</h1>
                                <p class="text-gray-600 mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px;">
                                    Maaf, saat ini belum ada soal untuk:
                                </p>
                                <div class="bg-blue-50 rounded-xl p-4 mb-4">
                                    <p class="font-semibold" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: ${primaryColor};">
                                        ${currentExam.subject}
                                    </p>
                                    <p class="text-gray-600 text-sm mt-1" style="font-family: ${customFont}, ${baseFontStack};">
                                        Kelas ${currentUser.class}
                                    </p>
                                </div>
                                <p class="text-gray-500 text-sm" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">
                                    Silakan hubungi admin atau pilih Ujian lain.
                                </p>
                            </div>
                            
                            <button onclick="backToLogin()" 
                                class="w-full py-3 rounded-lg text-white font-semibold hover:opacity-90 transition shadow-lg"
                                style="background: linear-gradient(135deg, ${primaryColor} 0%, ${config.secondary_color || defaultConfig.secondary_color} 100%); font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px;">
                                â¬…ï¸ Kembali ke Halaman Login
                            </button>
                        </div>
                    </div>
                `;
            }

            function backToLogin() {
                if (examTimer) clearInterval(examTimer);
                examSubmitted = false;
                currentUser = null;
                currentExam = null;
                examQuestions = [];
                studentAnswers = {};
                doubtQuestions = new Set();
                currentQuestionIndex = 0;
                remainingTime = 0;
                
                localStorage.clear();
                renderLoginPage();
            }

            function renderExamPage() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                const textColor = config.text_color || defaultConfig.text_color;
                
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="h-full flex flex-col">
                        <div class="gradient-header text-white px-3 md:px-6 py-3 md:py-4 shadow-lg" style="background: linear-gradient(135deg, ${primaryColor} 0%, ${config.secondary_color || defaultConfig.secondary_color} 100%);">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                                <div class="flex items-center gap-3 md:gap-4 w-full sm:w-auto">
                                    ${currentUser.photo && currentUser.photo.trim() !== '' ?
                                        `<img src="${currentUser.photo}" alt="Foto Siswa" class="w-10 h-10 md:w-12 md:h-12 rounded-full border-2 border-white object-cover flex-shrink-0" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-white bg-opacity-30 flex items-center justify-center text-xl md:text-2xl flex-shrink-0" style="display:none;">ðŸ‘¤</div>`
                                        :
                                        `<div class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-white bg-opacity-30 flex items-center justify-center text-xl md:text-2xl flex-shrink-0">ðŸ‘¤</div>`
                                    }
                                    <div class="flex-1 min-w-0">
                                        <h2 class="font-bold text-sm md:text-base truncate" style="font-family: ${customFont}, ${baseFontStack};">${currentUser.name}</h2>
                                        <p class="text-xs md:text-sm opacity-90 truncate" style="font-family: ${customFont}, ${baseFontStack};">Kelas ${currentUser.class} - INFORMATIKA ${currentExam.subject}</p>
                                    </div>
                                </div>

                                <!-- posisi notif online/offline -->
                                <div id="connection-status" class="fixed top-4 right-4 z-50 px-4 py-2 rounded-full text-sm font-bold hidden shadow-lg transition-all duration-300">
                                    <span id="status-text"></span>
                                </div>
                                <div class="flex items-center gap-2 md:gap-4 w-full sm:w-auto justify-between sm:justify-end">
                                    <div class="flex items-center gap-2 px-2 py-1 rounded-lg" style="background-color: ${violationCount > 0 ? '#fee2e2' : '#dcfce7'};">
                                        <span class="text-lg md:text-xl">${violationCount > 0 ? 'ðŸš¨' : 'âœ…'}</span>
                                        <span class="text-sm md:text-base font-semibold" style="font-family: ${customFont}, ${baseFontStack}; color: ${violationCount > 0 ? '#dc2626' : '#16a34a'};">
                                            Pelanggaran: <span id="violationCount">${violationCount}</span>
                                        </span>
                                    </div>
                                    <div id="timer" class="text-xl md:text-2xl font-bold" style="font-family: ${customFont}, ${baseFontStack};"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex-1 overflow-auto p-3 md:p-6">
                            <div class="max-w-4xl mx-auto">
                                <div id="questionContainer" class="bg-white rounded-xl shadow-custom p-4 md:p-8 mb-4 md:mb-6"></div>
                                
                                <div id="navigationButtons" class="flex flex-wrap gap-2 md:gap-3 justify-center mb-4 md:mb-6">
                                </div>
                                
                                <div class="bg-white rounded-xl shadow-custom p-4 md:p-6">
                                    <h3 class="font-bold mb-3 md:mb-4 text-sm md:text-base" style="font-family: ${customFont}, ${baseFontStack}; color: ${textColor};">Navigasi Soal</h3>
                                    <div id="questionNav" class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                startTimer();
                renderQuestion();
                renderQuestionNav();
                renderNavigationButtons();
                setupViolationDetection();
                requestWakeLock();
            }

            function updateConnectionStatus() {
                const statusDiv = document.getElementById('connection-status');
                const statusText = document.getElementById('status-text');

                // 1. PENGAMAN (PENTING!): Cek apakah elemen ada?
                // Jika tidak ada (misal di halaman login), stop fungsi agar tidak error.
                if (!statusDiv || !statusText) {
                    return;
                }

                if (navigator.onLine) {
                    // --- JIKA KEMBALI ONLINE ---
                    
                    // 2. Pastikan notifikasi MUNCUL dulu (Hapus 'hidden')
                    statusDiv.classList.remove('hidden');
                    
                    // Atur warna Hijau
                    statusDiv.classList.remove('bg-red-500');
                    statusDiv.classList.add('bg-green-500', 'text-white');
                    statusText.innerText = "ðŸŒ Akhirnya online lagi ðŸ¤—";

                    // 3. Sembunyikan pesan setelah 3 detik
                    // (Disimpan ke variabel agar tidak bentrok jika internet putus nyambung cepat)
                    clearTimeout(window.connectionTimeout); 
                    window.connectionTimeout = setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 3000);

                } else {
                    // --- JIKA OFFLINE ---
                    
                    // Batalkan timer sembunyi (agar pesan offline tidak hilang tiba-tiba)
                    if (window.connectionTimeout) clearTimeout(window.connectionTimeout);

                    // Pastikan notifikasi MUNCUL
                    statusDiv.classList.remove('hidden');
                    
                    // Atur warna Merah
                    statusDiv.classList.remove('bg-green-500');
                    statusDiv.classList.add('bg-red-500', 'text-white');
                    statusText.innerText = "ðŸš« Koneksi Terputus! Jangan Refresh HalamanðŸ¥¹";
                }
            }

            // Pastikan Event Listener dipasang
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);

            // Cek status saat pertama kali halaman dimuat
            document.addEventListener('DOMContentLoaded', updateConnectionStatus);
            
            function setupViolationDetection() {
                // Deteksi saat tab tidak aktif (berpindah tab atau minimize)
                // Hanya hitung pelanggaran saat KELUAR dari tab, bukan saat kembali

                document.addEventListener('visibilitychange', function() {
                    if (currentUser?.role === 'siswa' && currentExam && !examSubmitted) {
                        if (document.hidden && !isRefreshing) {
                            // Hanya tambah pelanggaran saat keluar dari tab
                            violationCount++;
                            sessionStorage.setItem('violationCount', violationCount.toString());
                            updateViolationDisplay();
                            showViolationWarning();
                        }
                        // Tidak ada aksi saat kembali ke tab (document.visible)                   
                        
                    }
                });
                
                // Deteksi klik kanan (mencoba buka menu context)
                document.addEventListener('contextmenu', function(e) {
                    if (currentUser && currentUser.role === 'siswa' && currentExam && !examSubmitted) {
                        e.preventDefault();
                        showToast('Klik kanan tidak diperbolehkan selama ujian', 'error');
                    }
                });
            }
            
            function updateViolationDisplay() {
                const violationElement = document.getElementById('violationCount');
                if (violationElement) {
                    violationElement.textContent = violationCount;
                    
                    // Update background color and icon
                    const violationContainer = violationElement.closest('div');
                    if (violationContainer) {
                        violationContainer.style.backgroundColor = violationCount > 0 ? '#fee2e2' : '#dcfce7';
                        violationElement.parentElement.style.color = violationCount > 0 ? '#dc2626' : '#16a34a';
                        
                        // Update icon
                        const iconSpan = violationContainer.querySelector('span:first-child');
                        if (iconSpan) {
                            iconSpan.textContent = violationCount > 0 ? 'ðŸš¨' : 'âœ…';
                        }
                    }
                }
            }
            
            function showViolationWarning() {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
                warningDiv.innerHTML = `
                    <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center shadow-2xl">
                        <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
                            <span class="text-5xl">âš ï¸</span>
                        </div>
                        <h2 class="text-2xl font-bold text-red-600 mb-3">PERINGATAN!</h2>
                        <p class="text-gray-700 mb-4">Anda terdeteksi keluar dari halaman ujian atau membuka tab/aplikasi lain.</p>
                        <div class="bg-red-50 rounded-lg p-4 mb-4">
                            <p class="text-red-800 font-semibold">Jumlah Pelanggaran: ${violationCount}</p>
                        </div>
                        <p class="text-sm text-gray-600 mb-6">Pelanggaran akan tercatat dan dilaporkan ke admin. Tetap fokus pada ujian Anda!</p>
                        <button onclick="this.closest('div.fixed').remove()" 
                            class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition">
                            Saya Mengerti, Lanjutkan Ujian
                        </button>
                    </div>
                `;
                document.body.appendChild(warningDiv);
                
                // Auto close after 10 seconds
                setTimeout(() => {
                    if (warningDiv.parentElement) {
                        warningDiv.remove();
                    }
                }, 10000);
            }

            function renderNavigationButtons() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                
                const navContainer = document.getElementById('navigationButtons');
                if (!navContainer) return;
                
                const isLastQuestion = currentQuestionIndex === examQuestions.length - 1;
                
                let buttonsHTML = '';
                
                if (currentQuestionIndex > 0) {
                    buttonsHTML += `
                        <button onclick="previousQuestion()" 
                            class="bg-red-500 hover:bg-red-600 text-white px-4 md:px-6 py-2 md:py-3 text-sm md:text-base rounded-lg font-semibold transition flex-shrink-0"
                            style="font-family: ${customFont}, ${baseFontStack};">
                            â¬…ï¸ Sebelumnya
                        </button>
                    `;
                }
                
                buttonsHTML += `
                    <button onclick="toggleDoubt()" 
                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 md:px-6 py-2 md:py-3 text-sm md:text-base rounded-lg font-semibold transition flex-shrink-0"
                        style="font-family: ${customFont}, ${baseFontStack};">
                        âš ï¸ Ragu-ragu
                    </button>
                `;
                
                if (isLastQuestion) {
                    buttonsHTML += `
                        <button onclick="submitExam()" 
                            class="bg-green-500 hover:bg-green-600 text-white px-4 md:px-6 py-2 md:py-3 text-sm md:text-base rounded-lg font-bold transition flex-shrink-0"
                            style="font-family: ${customFont}, ${baseFontStack};">
                            âœ… Selesai
                        </button>
                    `;
                } else {
                    buttonsHTML += `
                        <button onclick="nextQuestion()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 md:px-6 py-2 md:py-3 text-sm md:text-base rounded-lg font-semibold transition flex-shrink-0"
                            style="font-family: ${customFont}, ${baseFontStack};">
                            Berikutnya âž¡ï¸
                        </button>
                    `;
                }
                
                navContainer.innerHTML = buttonsHTML;
            }

            function renderQuestion() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const textColor = config.text_color || defaultConfig.text_color;
                
                if (!examQuestions || examQuestions.length === 0) {
                    document.getElementById('questionContainer').innerHTML = `
                        <div class="text-center py-12">
                            <p class="text-xl text-gray-600" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.25}px;">Tidak ada soal tersedia untuk ujian ini.</p>
                        </div>
                    `;
                    return;
                }
                
                const question = examQuestions[currentQuestionIndex];
                const container = document.getElementById('questionContainer');
                
                let questionHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.25}px; color: ${textColor};">Soal ${currentQuestionIndex + 1} dari ${examQuestions.length}</h3>
                            <span class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full font-semibold" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">
                                ${getQuestionTypeLabel(question.question_type)}
                            </span>
                        </div>
                        <p class="text-lg mb-4 break-words" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px; color: ${textColor}; word-break: break-word; overflow-wrap: break-word; white-space: pre-wrap;">${question.question_text}</p>
                        ${question.question_image && question.question_image.trim() !== '' ? 
                            `<div class="mb-4">
                                <img src="${question.question_image}" alt="Gambar Soal" class="max-w-full h-auto rounded-lg shadow-lg border-2 border-gray-300" 
                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" style="display:none; font-family: ${customFont}, ${baseFontStack};">
                                    âš ï¸ Gambar gagal dimuat
                                </div>
                            </div>` 
                            : ''
                        }
                    </div>
                `;
                
                if (question.question_type === 'pilihan_ganda') {
                    questionHTML += renderMultipleChoice(question);
                } else if (question.question_type === 'pilihan_ganda_kompleks') {
                    questionHTML += renderComplexMultipleChoice(question);
                } else if (question.question_type === 'isian_singkat') {
                    questionHTML += renderShortAnswer(question);
                } else if (question.question_type === 'benar_salah') {
                    questionHTML += renderTrueFalse(question);
                }
                
                container.innerHTML = questionHTML;
            }

            function getQuestionTypeLabel(type) {
                const labels = {
                    'pilihan_ganda': 'Pilihan Ganda',
                    'pilihan_ganda_kompleks': 'Pilihan Ganda Kompleks',
                    'isian_singkat': 'Isian Singkat',
                    'benar_salah': 'Benar/Salah'
                };
                return labels[type] || type;
            }

            function renderMultipleChoice(question) {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const textColor = config.text_color || defaultConfig.text_color;
                
                const currentAnswer = studentAnswers[currentQuestionIndex];
                
                return `
                    <div class="space-y-3">
                        ${question.options.map((option, idx) => `
                            <label class="flex items-start p-4 border-2 rounded-lg cursor-pointer hover:bg-blue-50 transition ${currentAnswer === option ? 'border-blue-500 bg-blue-50' : 'border-gray-300'}">
                                <input type="radio" name="answer" value="${option.replace(/"/g, '&quot;')}" 
                                    ${currentAnswer === option ? 'checked' : ''}
                                    onchange="saveAnswer(${idx})"
                                    class="mt-1 w-5 h-5 text-blue-600 flex-shrink-0">
                                
                                <div class="ml-3 flex-1 flex items-start gap-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: ${textColor};">
                                    <span class="font-bold flex-shrink-0">${String.fromCharCode(65 + idx)}.</span>
                                    
                                    <div class="quill-content-render break-words w-full" style="word-break: break-word; overflow-wrap: break-word;">
                                        ${option}
                                    </div>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                `;
            }

            function renderComplexMultipleChoice(question) {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const textColor = config.text_color || defaultConfig.text_color;
                
                const currentAnswer = studentAnswers[currentQuestionIndex] || "";
                
                let selectedOptions = [];
                if (Array.isArray(currentAnswer)) {
                    selectedOptions = currentAnswer;
                } else if (typeof currentAnswer === 'string' && currentAnswer.trim() !== "") {
                    selectedOptions = currentAnswer.split(',');
                }
                
                return `
                    <div class="space-y-3">
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4 rounded-r-lg">
                            <p class="text-sm font-bold text-blue-800" style="font-family: ${customFont}, ${baseFontStack};">
                                ðŸ’¡ Pilih semua jawaban yang menurut Anda benar.
                            </p>
                        </div>

                        <div class="grid grid-cols-1 gap-3">
                            ${question.options.filter(opt => opt && opt.trim() !== "").map((option, idx) => {
                                const isChecked = selectedOptions.includes(option);
                                return `
                                    <label class="group flex items-center p-4 border-2 rounded-xl cursor-pointer transition-all duration-200 
                                        ${isChecked ? 'border-blue-500 bg-blue-50 shadow-sm' : 'border-gray-200 bg-white hover:border-gray-400'}">
                                        
                                        <div class="flex items-center justify-center flex-shrink-0">
                                            <input type="checkbox" value="${option.replace(/"/g, '&quot;')}" 
                                                ${isChecked ? 'checked' : ''}
                                                onchange="saveComplexAnswer(this)"
                                                class="w-6 h-6 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer">
                                        </div>

                                        <div class="ml-4 flex-grow">
                                            <div class="break-words leading-relaxed" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: ${textColor};">
                                                ${option}
                                            </div>
                                        </div>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            function renderShortAnswer(question) {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                
                const currentAnswer = studentAnswers[currentQuestionIndex] || '';
                
                return `
                    <div class="mt-4">
                        <label class="block text-blue-700 font-bold mb-3 uppercase tracking-wide" 
                            style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.8}px;">
                            âœï¸ Tulis Jawaban Singkat:
                        </label>
                        
                        <input type="text" 
                            id="input-isian-${currentQuestionIndex}"
                            oninput="saveAnswer(this.value)" 
                            class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl shadow-sm focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all text-gray-800"
                            style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.1}px;"
                            placeholder="Ketik jawaban di sini..."
                            value="${currentAnswer.replace(/"/g, '&quot;')}"
                            autocomplete="off">
                            
                        <p class="mt-2 text-xs text-gray-400 font-medium">*Jawaban tersimpan otomatis saat Anda mengetik.</p>
                    </div>
                `;
            }

            function renderTrueFalse(question) {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const textColor = config.text_color || defaultConfig.text_color;
                
                // Ambil jawaban saat ini dari array studentAnswers
                const currentAnswer = studentAnswers[currentQuestionIndex] || "";
                
                return `
                    <div class="mt-6">
                        <div class="bg-gray-50 border-2 border-gray-200 rounded-2xl p-6 shadow-sm">
                            <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                                
                                <label class="w-full sm:w-1/2 flex items-center p-4 border-2 rounded-xl cursor-pointer transition-all 
                                    ${currentAnswer === 'Benar' ? 'border-green-500 bg-green-50' : 'border-gray-300 bg-white hover:bg-gray-50'}">
                                    <input type="radio" name="true_false_choice" value="Benar" 
                                        ${currentAnswer === 'Benar' ? 'checked' : ''}
                                        onchange="saveAnswerDirect('Benar')"
                                        class="w-6 h-6 text-green-600 border-gray-300 focus:ring-green-500">
                                    <span class="ml-3 font-bold text-gray-700" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">BENAR</span>
                                </label>

                                <label class="w-full sm:w-1/2 flex items-center p-4 border-2 rounded-xl cursor-pointer transition-all 
                                    ${currentAnswer === 'Salah' ? 'border-red-500 bg-red-50' : 'border-gray-300 bg-white hover:bg-gray-50'}">
                                    <input type="radio" name="true_false_choice" value="Salah" 
                                        ${currentAnswer === 'Salah' ? 'checked' : ''}
                                        onchange="saveAnswerDirect('Salah')"
                                        class="w-6 h-6 text-red-600 border-gray-300 focus:ring-red-500">
                                    <span class="ml-3 font-bold text-gray-700" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">SALAH</span>
                                </label>

                            </div>
                        </div>
                    </div>
                `;
            }

            function saveAnswerDirect(value) {
                // 1. Simpan langsung teksnya (Benar/Salah) ke array
                studentAnswers[currentQuestionIndex] = value;

                // 2. Simpan ke storage
                const encodedAnswers = JSON.stringify(studentAnswers);
                sessionStorage.setItem('studentAnswers', encodedAnswers);
                localStorage.setItem('studentAnswers', encodedAnswers);

                // 3. Update navigasi dan tampilan
                renderQuestionNav();
                renderQuestion(); 
            }

            function saveAnswer(indexOrText) {
                const currentQuestion = examQuestions[currentQuestionIndex];
                let finalAnswer;

                // 1. Logika Penentuan Jawaban
                if (currentQuestion.question_type === 'isian_singkat' || currentQuestion.question_type === 'benar_salah') {
                    // Ambil nilai teks langsung (Benar/Salah atau hasil ketikan)
                    finalAnswer = indexOrText;
                } else {
                    // Ambil dari array options berdasarkan index (Pilihan Ganda)
                    finalAnswer = currentQuestion.options[indexOrText];
                }

                // 2. Simpan ke array jawaban siswa
                studentAnswers[currentQuestionIndex] = finalAnswer;

                // 3. Simpan ke storage (Local & Session)
                const encodedAnswers = JSON.stringify(studentAnswers);
                sessionStorage.setItem('studentAnswers', encodedAnswers);
                localStorage.setItem('studentAnswers', encodedAnswers);

                // 4. Update warna navigasi nomor soal
                renderQuestionNav();

                // 5. LOGIKA RENDER ULANG (CRITICAL)
                // Kita HANYA memblokir render ulang jika tipenya 'isian_singkat'.
                // Selain itu (pilihan ganda, benar_salah, kompleks), WAJIB render ulang agar UI berubah.
                if (currentQuestion.question_type !== 'isian_singkat') {
                    renderQuestion();
                }
            }

            function saveComplexAnswer(checkbox) {
                const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
                const selected = Array.from(checkboxes).map(cb => cb.value);
                studentAnswers[currentQuestionIndex] = selected;
                sessionStorage.setItem('studentAnswers', JSON.stringify(studentAnswers));
                localStorage.setItem('studentAnswers', JSON.stringify(studentAnswers)); // Tambahkan ini
                renderQuestionNav();
            }

            function saveTrueFalseAnswer(index, value) {
                const currentAnswer = studentAnswers[currentQuestionIndex] || {};
                const answers = typeof currentAnswer === 'string' ? JSON.parse(currentAnswer || '{}') : currentAnswer;
                answers[index] = value;
                studentAnswers[currentQuestionIndex] = answers;
                sessionStorage.setItem('studentAnswers', JSON.stringify(studentAnswers));
                localStorage.setItem('studentAnswers', JSON.stringify(studentAnswers)); // Tambahkan ini
                renderQuestionNav();
            }

            function renderQuestionNav() {
                const nav = document.getElementById('questionNav');
                if (!nav) return;
                
                nav.innerHTML = examQuestions.map((_, idx) => {
                    let className = 'question-nav-btn rounded-lg font-semibold flex items-center justify-center cursor-pointer unanswered';
                    
                    if (studentAnswers[idx] !== undefined && studentAnswers[idx] !== '' && 
                        (!Array.isArray(studentAnswers[idx]) || studentAnswers[idx].length > 0) &&
                        (typeof studentAnswers[idx] !== 'object' || Object.keys(studentAnswers[idx]).length > 0)) {
                        className = className.replace('unanswered', 'answered');
                    }
                    
                    if (doubtQuestions.has(idx)) {
                        className = className.replace('answered', 'doubt').replace('unanswered', 'doubt');
                    }
                    
                    if (idx === currentQuestionIndex) {
                        className += ' current';
                    }
                    
                    return `<div class="${className}" onclick="goToQuestion(${idx})">${idx + 1}</div>`;
                }).join('');
            }

            function goToQuestion(index) {
                currentQuestionIndex = index;
                sessionStorage.setItem('currentQuestionIndex', currentQuestionIndex.toString());
                renderQuestion();
                renderQuestionNav();
                renderNavigationButtons();
            }

            function previousQuestion() {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    sessionStorage.setItem('currentQuestionIndex', currentQuestionIndex.toString());
                    renderQuestion();
                    renderQuestionNav();
                    renderNavigationButtons();
                }
            }

            function nextQuestion() {
                if (currentQuestionIndex < examQuestions.length - 1) {
                    currentQuestionIndex++;
                    sessionStorage.setItem('currentQuestionIndex', currentQuestionIndex.toString());
                    renderQuestion();
                    renderQuestionNav();
                    renderNavigationButtons();
                }
            }

            function toggleDoubt() {
                if (doubtQuestions.has(currentQuestionIndex)) {
                    doubtQuestions.delete(currentQuestionIndex);
                } else {
                    doubtQuestions.add(currentQuestionIndex);
                }
                sessionStorage.setItem('doubtQuestions', JSON.stringify(Array.from(doubtQuestions)));
                renderQuestionNav();
            }

            function startTimer() {
                if (examTimer) clearInterval(examTimer);

                // Kunci unik untuk memori localStorage agar tidak tertukar
                const timerKey = `timer_${currentUser.name}_${currentExam.subject}`;
                
                // 1. Cek apakah sudah ada target waktu selesai di memori (lanjutkan ujian)
                let targetEndTime = localStorage.getItem(timerKey);
                
                // 2. Jika belum ada (ujian baru dimulai), buat target waktu baru
                if (!targetEndTime) {
                    // Durasi ujian diambil dari examSettings (dikalikan 60 ribu untuk jadi milidetik)
                    targetEndTime = Date.now() + (examSettings.exam_duration * 60 * 1000);
                    localStorage.setItem(timerKey, targetEndTime);
                }

                // 3. Jalankan Interval
                examTimer = setInterval(() => {
                    const now = Date.now();
                    const distance = targetEndTime - now; // Hitung sisa waktu aktual

                    if (distance <= 0) {
                        // JIKA WAKTU HABIS
                        clearInterval(examTimer);
                        document.getElementById('timer').innerText = "00:00";
                        
                        // Hapus rekaman memori timer
                        localStorage.removeItem(timerKey); 
                        
                        // Tampilkan pop-up dan kumpulkan jawaban otomatis
                        Swal.fire({
                            icon: 'info',
                            title: 'Waktu Habis!',
                            text: 'Sistem sedang mengirim jawaban Anda ke server...',
                            timer: 2500, /* Pop-up akan otomatis hilang dalam 2.5 detik */
                            timerProgressBar: true,
                            allowOutsideClick: false,
                            showConfirmButton: false,
                            heightAuto: false,
                            //confirmButtonColor: '#3b82f6'
                            didOpen: () => {
                                Swal.showLoading(); // Tampilkan animasi muter-muter
                            }
                        });
                            submitExam(true); // langsung eksekusi kirim
                        
                    } else {
                        // JIKA WAKTU MASIH ADA (Konversi milidetik ke Menit & Detik)
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                        // Tambahkan angka 0 di depan jika di bawah 10 (contoh: 09:05)
                        const displayMinutes = minutes < 10 ? "0" + minutes : minutes;
                        const displaySeconds = seconds < 10 ? "0" + seconds : seconds;

                        // Tampilkan ke elemen timer di layar
                        const timerDisplay = document.getElementById('timer');
                        if (timerDisplay) {
                            timerDisplay.innerText = `${displayMinutes}:${displaySeconds}`;
                            
                            // Tambahkan efek kedap-kedip (pulse) jika waktu sisa <= 5 menit
                            if (minutes < 5) {
                                timerDisplay.classList.add('text-red-500', 'animate-pulse');
                            } else {
                                timerDisplay.classList.remove('text-red-500', 'animate-pulse');
                            }
                        }
                    }
                }, 1000);
            }

            async function submitExam(isAutoSubmit = false) {
                if (!navigator.onLine) {
                    alert("Gagal mengirim! Koneksi internet Anda terputus. Silakan cari sinyal dan coba lagi."); //nottif offline
                    return; // Hentikan proses pengiriman
                }

                // --- MULAI PERUBAHAN PENGECEKAN WAKTU MINIMAL ---
                const timerKey = `timer_${currentUser.name}_${currentExam.subject}`;
                let distance = 0; // Sisa waktu dalam milidetik
                let remainingSeconds = 0; // Sisa waktu dalam detik
                
                // Ambil target waktu selesai dari memori
                const targetEndTime = localStorage.getItem(timerKey);
                
                if (targetEndTime) {
                    distance = targetEndTime - Date.now();
                    remainingSeconds = Math.floor(distance / 1000);
                }
                
                // Cek apakah sisa waktu masih di atas minimum yang diizinkan
                const minTimeInSeconds = minTimeToSubmit * 60;

                if (!isAutoSubmit && remainingSeconds > minTimeInSeconds && minTimeToSubmit > 0) {
                    const remainingMinutesToShow = Math.floor(remainingSeconds / 60);
                    const remainingSecondsToShow = remainingSeconds % 60;
                    showSubmitWarning(remainingMinutesToShow, remainingSecondsToShow, minTimeToSubmit);
                    return;
                }
                // --- AKHIR PERUBAHAN PENGECEKAN WAKTU MINIMAL ---

                if (!isAutoSubmit) {
                    if (!confirm('Apakah Anda yakin ingin menyelesaikan ujian?')) return;
                }
                
                // Matikan interval timer
                if (examTimer) clearInterval(examTimer);
                
                if (wakeLock !== null) {
                    wakeLock.release().then(() => {
                        wakeLock = null;
                        console.log('Wake Lock dilepas, layar bisa mati otomatis kembali.');
                    }).catch((err) => console.error('Gagal melepas Wake Lock:', err));
                }
                
                showLoading();
                // Tambahkan delay acak antara 1 hingga 10 detik agar tidak serentak
                const randomDelay = Math.floor(Math.random() * 3000);
                await new Promise(resolve => setTimeout(resolve, randomDelay));
                
                // Tandai bahwa ujian sudah selesai untuk menonaktifkan deteksi pelanggaran
                examSubmitted = true;
                hasSubmitted = true;

                // Kirim sinyal "SELESAI" ke Admin sekarang juga
                if (typeof laporKeAdmin === 'function') {
                    await laporKeAdmin(); 
                }

                const score = calculateScore();
                const answersString = JSON.stringify(studentAnswers);
                const examData = {
                    student_name: currentUser.name,
                    student_class: currentUser.class,
                    exam_subject: currentExam.subject,
                    exam_time: new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'}),
                    answers: answersString,
                    final_score: score,
                    violations: violationCount
                };

                // --- MULAI PENAMBAHAN PENGHAPUSAN MEMORI TIMER ---
                localStorage.removeItem(timerKey); // <--- INI KODE BARU YANG DITAMBAHKAN
                // --- AKHIR PENAMBAHAN ---

                // HAPUS data ujian dari penyimpanan lokal agar siswa bisa login ulang untuk ujian baru
                localStorage.removeItem('studentAnswers');
                localStorage.removeItem('currentExam');
                localStorage.removeItem('currentQuestionIndex');
                localStorage.removeItem('remainingTime');
                localStorage.removeItem('violationCount');
                localStorage.removeItem('doubtQuestions');
                // Jika ingin benar-benar bersih, gunakan: 
                sessionStorage.removeItem('currentUser');
                sessionStorage.removeItem('currentExam');
                sessionStorage.removeItem('studentAnswers');
                sessionStorage.removeItem('doubtQuestions');
                sessionStorage.removeItem('currentQuestionIndex');
                sessionStorage.removeItem('remainingTime');
                sessionStorage.removeItem('violationCount');
                
                const success = await saveExamResultToSheet(examData);
                
                if (success) {
                    // Reload data untuk update hasil ujian terbaru
                    await loadExamData();
                }
                            
                if (success) {
                    renderResultPage(score);
                }
            }

            // Fungsi pembantu untuk membersihkan HTML dan spasi (Letakkan di luar calculateScore)
            function normalizeText(input) {
                if (!input) return "";
                // Jika input berupa array (untuk PG Kompleks), bersihkan setiap elemennya
                if (Array.isArray(input)) return input.map(i => normalizeText(i)).sort().join(',');
                
                // Jika input berupa string/HTML
                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = input;
                return tempDiv.textContent || tempDiv.innerText || "";
            }

            function calculateScore() {
                let correctAnswers = 0;
                if (!examQuestions || examQuestions.length === 0) return 0;

                examQuestions.forEach((question, idx) => {
                    const rawStudent = studentAnswers[idx];
                    let answerKey;

                    // 1. Dekode dan Parsing Kunci Jawaban
                    try {
                        const decodedKey = atob(question.security_token || "");
                        answerKey = JSON.parse(decodedKey);
                    } catch {
                        answerKey = atob(question.security_token || "");
                    }

                    // 2. Validasi: Jangan hitung jika siswa tidak menjawab
                    if (rawStudent === undefined || rawStudent === null || rawStudent === "" || (Array.isArray(rawStudent) && rawStudent.length === 0)) {
                        return;
                    }

                    // 3. Logika Perbandingan Per Tipe Soal
                    const type = question.question_type;

                    if (type === 'pilihan_ganda' || type === 'benar_salah' || type === 'isian_singkat') {
                        // Bandingkan teks murni, abaikan spasi depan/belakang dan huruf besar/kecil
                        const sAns = normalizeText(rawStudent).trim().toLowerCase();
                        const kAns = normalizeText(answerKey).trim().toLowerCase();
                        
                        if (sAns === kAns) correctAnswers++;
                    } 
                    else if (type === 'pilihan_ganda_kompleks') {
                        // 1. Pastikan jawaban siswa jadi Array, bersihkan HTML, dan urutkan
                        let sArray = Array.isArray(rawStudent) ? rawStudent : [rawStudent];
                        let sNormalized = sArray
                            .map(item => normalizeText(item).trim().toUpperCase())
                            .filter(item => item !== "") // Buang jika ada string kosong
                            .sort();

                        // 2. Pastikan kunci jawaban jadi Array, bersihkan HTML, dan urutkan
                        let kArray = [];
                        if (Array.isArray(answerKey)) {
                            kArray = answerKey;
                        } else {
                            // Jika kunci berupa string "A,C" atau "A, C", pecah jadi array
                            kArray = String(answerKey).split(',');
                        }

                        let kNormalized = kArray
                            .map(item => normalizeText(item).trim().toUpperCase())
                            .filter(item => item !== "")
                            .sort();

                        // 3. Bandingkan isi array yang sudah jadi string murni
                        const sFinal = sNormalized.join(',');
                        const kFinal = kNormalized.join(',');

                        if (sFinal !== "" && sFinal === kFinal) {
                            correctAnswers++;
                        }
                    }
                });

                return Math.round((correctAnswers / examQuestions.length) * 100);
            }

            function renderResultPage(score) {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                const textColor = config.text_color || defaultConfig.text_color;
                        
                document.getElementById('app').innerHTML = `
                    <div class="min-h-full flex items-center justify-center p-4 gradient-bg">
                        <div class="max-w-2xl w-full bg-white rounded-2xl shadow-custom p-8 text-center">
                            <div class="mb-6">
                                <div class="w-24 h-24 mx-auto mb-4 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, ${primaryColor} 0%, ${config.secondary_color || defaultConfig.secondary_color} 100%);">
                                    <span class="text-5xl">âœ…</span>
                                </div>
                                <h1 class="font-bold mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 2}px; color: ${textColor};">Ujian Selesai!</h1>
                                <p class="text-gray-600" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px;">Terima kasih telah menyelesaikan ujian</p>
                            </div>
                            
                            ${examSettings.show_score ? `
                                <div class="grid grid-cols-1 gap-4 mb-6">
                                    <div class="bg-blue-50 rounded-xl p-6">
                                        <p class="text-gray-700 mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">Nilai Angka:</p>
                                        <p class="font-bold" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 3}px; color: ${primaryColor};">${score}</p>
                                    </div>
                                </div>
                            ` : `
                                <div class="bg-blue-50 rounded-xl p-6 mb-6">
                                    <p class="text-gray-700" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px;">Hasil ujian Anda telah disimpan. Nilai akan diumumkan kemudian.</p>
                                </div>
                            `}
                            
                            <button onclick="logout()" 
                                class="w-full py-3 rounded-lg text-white font-semibold hover:opacity-90 transition"
                                style="background: linear-gradient(135deg, ${primaryColor} 0%, ${config.secondary_color || defaultConfig.secondary_color} 100%); font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px;">
                                Kembali ke Halaman Login
                            </button>
                        </div>
                    </div>
                `;
            }

            function showSubmitWarning(remainingMinutes, remainingSeconds, minTimeToSubmit) {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                
                const warningDiv = document.createElement('div');
                warningDiv.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
                warningDiv.id = 'submitWarningModal';
                warningDiv.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 md:p-8 max-w-md mx-auto text-center shadow-2xl">
                        <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
                            <span class="text-5xl">â°</span>
                        </div>
                        <h2 class="text-xl md:text-2xl font-bold text-red-600 mb-3" style="font-family: ${customFont}, ${baseFontStack};">TIDAK DAPAT SUBMIT!</h2>
                        <p class="text-gray-700 mb-4" style="font-family: ${customFont}, ${baseFontStack};">Anda belum bisa mengumpulkan ujian karena waktu masih tersisa terlalu banyak.</p>
                        <div class="bg-red-50 rounded-lg p-4 mb-4">
                            <p class="text-red-800 font-semibold mb-2" style="font-family: ${customFont}, ${baseFontStack};">Sisa Waktu Anda:</p>
                            <p id="warningTimerDisplay" class="text-3xl font-bold text-red-600 mb-3" style="font-family: ${customFont}, ${baseFontStack};">${remainingMinutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}</p>
                            <p class="text-sm text-red-700" style="font-family: ${customFont}, ${baseFontStack};">Anda baru bisa submit jika sisa waktu â‰¤ ${minTimeToSubmit} menit</p>
                        </div>
                        <p class="text-sm text-gray-600 mb-6" style="font-family: ${customFont}, ${baseFontStack};">Silakan gunakan waktu yang tersisa untuk memeriksa kembali jawaban Anda.</p>
                        <button onclick="closeSubmitWarning()" 
                            class="w-full px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition"
                            style="font-family: ${customFont}, ${baseFontStack};">
                            Kembali ke Ujian
                        </button>
                    </div>
                `;
                document.body.appendChild(warningDiv);
                
                // Update timer setiap detik di dalam notif
                const warningTimerInterval = setInterval(() => {
                    const warningTimerDisplay = document.getElementById('warningTimerDisplay');
                    if (!warningTimerDisplay || !document.getElementById('submitWarningModal')) {
                        clearInterval(warningTimerInterval);
                        return;
                    }
                    
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    warningTimerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
                
                // Simpan interval ID untuk dibersihkan nanti
                warningDiv.dataset.intervalId = warningTimerInterval;
            }
            
            function closeSubmitWarning() {
                const modal = document.getElementById('submitWarningModal');
                if (modal) {
                    // Bersihkan interval jika ada
                    if (modal.dataset.intervalId) {
                        clearInterval(parseInt(modal.dataset.intervalId));
                    }
                    modal.remove();
                }
            }

            function logout() {
                if (examTimer) clearInterval(examTimer);
                if (adminRefreshInterval) clearInterval(adminRefreshInterval);
                isExamActive = false;
                examSubmitted = false;
                currentUser = null;
                currentExam = null;
                examQuestions = [];
                studentAnswers = {};
                doubtQuestions = new Set();
                currentQuestionIndex = 0;
                remainingTime = 0;
                violationCount = 0;
                
                localStorage.removeItem('violationCount');
                
                renderLoginPage();
            }

            // ============================================
            // ADMIN DASHBOARD
            // ============================================
            let adminRefreshInterval = null;
            
            function renderAdminDashboard() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                const textColor = config.text_color || defaultConfig.text_color;
                
                // Start auto refresh setiap 30 detik
                if (adminRefreshInterval) {
                    clearInterval(adminRefreshInterval);
                }
                adminRefreshInterval = setInterval(async () => {
                await loadExamData(true); // Tambahkan true agar loading tidak muncul
                updateDashboardStats();
                
                /// 3. Cek tab mana yang sedang dibuka, lalu render ulang tab tersebut
                // Pastikan nama fungsi render di bawah sesuai dengan yang ada di kode Anda
                if (currentAdminTab === 'results') {
                    renderResultsSection(); // Render ulang tabel hasil
                } else if (currentAdminTab === 'dashboard') {
                    renderDashboardSection(); // Render ulang bank soal
                }
                }, 5000); // Refresh setiap 30 detik
                
                document.getElementById('app').innerHTML = `
                    <div class="h-full flex flex-col">
                        <div class="gradient-header text-white shadow-lg" style="background: linear-gradient(90deg, ${primaryColor} 0%, ${config.secondary_color || defaultConfig.secondary_color} 100%);">
                            <div class="px-4 md:px-6 py-3 md:py-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2 md:gap-3">
                                        <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center flex-shrink-0">
                                            <span class="text-xl md:text-2xl">ðŸ‘¨â€ðŸ’¼</span>
                                        </div>
                                        <div>
                                            <h2 class="font-bold text-sm md:text-base" style="font-family: ${customFont}, ${baseFontStack};">Admin Panel</h2>
                                            <p class="text-xs opacity-80 hidden sm:block" style="font-family: ${customFont}, ${baseFontStack};">${currentUser.name}</p>
                                        </div>
                                    </div>
                                    
                                    <button onclick="logout()"
                                        class="px-3 py-1.5 md:px-4 md:py-2 text-sm rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition flex-shrink-0"
                                        style="font-family: ${customFont}, ${baseFontStack};">
                                        Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <nav class="bg-white shadow-md border-b border-gray-200">
                            <div class="px-4 md:px-6">
                                <div class="flex overflow-x-auto gap-1 md:gap-2 scrollbar-hide py-2">
                                    <button onclick="showAdminSection('dashboard')" id="nav-dashboard"
                                        class="px-4 py-2.5 text-sm md:text-base rounded-lg transition whitespace-nowrap flex-shrink-0 touch-manipulation"
                                        style="font-family: ${customFont}, ${baseFontStack}; min-width: 130px; -webkit-tap-highlight-color: transparent;">
                                        ðŸ“Š Dashboard
                                    </button>
                                    <button onclick="showAdminSection('users')" id="nav-users"
                                        class="px-4 py-2.5 text-sm md:text-base rounded-lg transition whitespace-nowrap flex-shrink-0 touch-manipulation"
                                        style="font-family: ${customFont}, ${baseFontStack}; min-width: 130px; -webkit-tap-highlight-color: transparent;">
                                        ðŸ‘¥ Pengguna
                                    </button>
                                    <button onclick="showAdminSection('results')" id="nav-results"
                                        class="px-4 py-2.5 text-sm md:text-base rounded-lg transition whitespace-nowrap flex-shrink-0 touch-manipulation"
                                        style="font-family: ${customFont}, ${baseFontStack}; min-width: 130px; -webkit-tap-highlight-color: transparent;">
                                        ðŸ† Hasil
                                    </button>
                                    <button onclick="showAdminSection('questions')" id="nav-questions"
                                        class="px-4 py-2.5 text-sm md:text-base rounded-lg transition whitespace-nowrap flex-shrink-0 touch-manipulation"
                                        style="font-family: ${customFont}, ${baseFontStack}; min-width: 130px; -webkit-tap-highlight-color: transparent;">
                                        ðŸ“š Bank Soal
                                    </button>
                                    <button onclick="showAdminSection('settings')" id="nav-settings"
                                        class="px-4 py-2.5 text-sm md:text-base rounded-lg transition whitespace-nowrap flex-shrink-0 touch-manipulation"
                                        style="font-family: ${customFont}, ${baseFontStack}; min-width: 130px; -webkit-tap-highlight-color: transparent;">
                                        âš™ï¸ Pengaturan
                                    </button>
                                    <button onclick="showAdminSection('schedule')" id="nav-schedule"
                                        class="px-4 py-2.5 text-sm md:text-base rounded-lg transition whitespace-nowrap flex-shrink-0 touch-manipulation"
                                        style="font-family: ${customFont}, ${baseFontStack}; min-width: 130px; -webkit-tap-highlight-color: transparent;">
                                        ðŸ“… Jadwal Ujian
                                    </button>

                                    <button onclick="bukaMonitoring()"
                                    class="px-4 py-2.5 text-sm md:text-base rounded-lg transition whitespace-nowrap flex-shrink-0 touch-manipulation bg-red-50 text-red-600 font-bold border border-red-200 hover:bg-red-100"
                                    style="font-family: ${customFont}, ${baseFontStack}; min-width: 130px;">
                                    ðŸ“¡ Live Monitor
                                </button>
                                </div>
                            </div>
                        </nav>
                        
                        <div class="flex-1 overflow-auto p-3 md:p-6 gradient-bg">
                            <div id="adminContent" class="max-w-7xl mx-auto"></div>
                        </div>
                        <div id="monitorPanel" class="fixed inset-0 bg-gray-100 z-50 hidden overflow-auto flex flex-col">
                            <div class="bg-white shadow p-4 sticky top-0 z-10">
                                <div class="max-w-7xl mx-auto flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <span class="animate-pulse text-red-600 text-xl">â—</span>
                                        <h2 class="text-xl font-bold text-gray-800">Live Monitoring Siswa</h2>
                                    </div>
                                    <button onclick="document.getElementById('monitorPanel').classList.add('hidden')" class="bg-red-600 text-white px-4 py-2 rounded shadow hover:bg-red-700 text-sm">
                                        Tutup Monitor
                                    </button>
                                </div>
                            </div>

                            <div class="p-4 md:p-6 max-w-7xl mx-auto w-full">
                                <div class="bg-white rounded-lg shadow overflow-x-auto">
                                    <table class="min-w-full text-sm">
                                        <thead class="bg-gray-800 text-white">
                                            <tr>
                                                <th class="p-3 text-left">Nama Siswa</th>
                                                <th class="p-3 text-left">Kelas</th>
                                                <th class="px-5 py-3 whitespace-nowrap">Mapel</th>
                                                <th class="p-3 text-center">Status</th>
                                                <th class="p-3 text-center">Progress</th>
                                                <th class="p-3 text-right">Update</th>
                                            </tr>
                                        </thead>
                                        <tbody id="monitorTableBody">
                                            </tbody>
                                    </table>
                                    <p id="loadingText" class="text-center p-8 text-gray-500">Menunggu sinyal dari siswa...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                showAdminSection('dashboard');
            }

            function renderGuruDashboard() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                const textColor = config.text_color || defaultConfig.text_color;
                
                
                // Start auto refresh setiap 30 detik
                if (adminRefreshInterval) {
                    clearInterval(adminRefreshInterval);
                }
                adminRefreshInterval = setInterval(async () => {
                    await loadExamData(true);
                    updateDashboardStats(); // Update statistik guru

                }, 5000); // Refresh setiap 30 menit
                
                document.getElementById('app').innerHTML = `
                    <div class="h-full flex flex-col">
                        <div class="gradient-header text-white shadow-lg" style="background: linear-gradient(90deg, ${primaryColor} 0%, ${config.secondary_color || defaultConfig.secondary_color} 100%);">
                            <div class="px-4 md:px-6 py-3 md:py-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2 md:gap-3">
                                        <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center flex-shrink-0">
                                            <span class="text-xl md:text-2xl">ðŸ‘¨â€ðŸ’¼</span>
                                        </div>
                                        <div>
                                            <h2 class="font-bold text-sm md:text-base" style="font-family: ${customFont}, ${baseFontStack};">Guru Panel</h2>
                                            <p class="text-xs opacity-80 hidden sm:block" style="font-family: ${customFont}, ${baseFontStack};">${currentUser.name} - ${currentUser.subject}</p>
                                        </div>
                                    </div>
                                    
                                    <button onclick="logout()"
                                        class="px-3 py-1.5 md:px-4 md:py-2 text-sm rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition flex-shrink-0"
                                        style="font-family: ${customFont}, ${baseFontStack};">
                                        Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <nav class="bg-white shadow-md border-b border-gray-200">
                            <div class="px-4 md:px-6">
                                <div class="flex overflow-x-auto gap-1 md:gap-2 scrollbar-hide py-2">
                                    <button onclick="showGuruSection('dashboard')" id="nav-dashboard"
                                        class="px-4 py-2.5 text-sm md:text-base rounded-lg transition whitespace-nowrap flex-shrink-0 touch-manipulation"
                                        style="font-family: ${customFont}, ${baseFontStack}; min-width: 130px; -webkit-tap-highlight-color: transparent;">
                                        ðŸ“Š Dashboard
                                    </button>
                                    <button onclick="showGuruSection('questions')" id="nav-questions"
                                        class="px-4 py-2.5 text-sm md:text-base rounded-lg transition whitespace-nowrap flex-shrink-0 touch-manipulation"
                                        style="font-family: ${customFont}, ${baseFontStack}; min-width: 130px; -webkit-tap-highlight-color: transparent;">
                                        ðŸ“š Bank Soal
                                    </button>
                                </div>
                            </div>
                        </nav>
                        
                        <div class="flex-1 overflow-auto p-3 md:p-6 gradient-bg">
                            <div id="guruContent" class="max-w-7xl mx-auto"></div>
                        </div>
                    </div>
                `;
                
                showGuruSection('dashboard');

            }
            
            function updateDashboardStats() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                
                const totalUsers = allUsers.length;
                const totalStudents = allUsers.filter(u => u.role === 'siswa').length;
                const totalQuestions = allQuestions.length;
                const totalExams = allExamResults.length;
                
                const avgScore = allExamResults.length > 0 
                    ? Math.round(allExamResults.reduce((sum, r) => sum + r.final_score, 0) / allExamResults.length)
                    : 0;
                
                // Update stats cards jika ada
                const statsCards = document.querySelectorAll('#adminContent .bg-white.rounded-xl.shadow');
                if (statsCards.length > 0) {
                    const stats = [totalUsers, totalQuestions, totalExams, avgScore];
                    const descriptions = [`${totalStudents} Siswa`, 'Soal Tersedia', 'Total Ujian', 'Nilai Rata-rata'];
                    
                    statsCards.forEach((card, idx) => {
                        if (idx < 4) {
                            const valueElement = card.querySelector('p.font-bold');
                            const descElement = card.querySelector('p.text-gray-500');
                            if (valueElement) valueElement.textContent = stats[idx];
                            if (descElement) descElement.textContent = descriptions[idx];
                        }
                    });
                }
            }

            function showAdminSection(section) {
                currentAdminTab = section;
                const config = window.elementSdk?.config || defaultConfig;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                
                document.querySelectorAll('[id^="nav-"]').forEach(btn => {
                    btn.classList.remove('bg-blue-100', 'text-blue-800', 'font-semibold');
                    btn.style.backgroundColor = '';
                    btn.style.color = '';
                });
                
                const activeBtn = document.getElementById(`nav-${section}`);
                activeBtn.style.backgroundColor = `${primaryColor}15`;
                activeBtn.style.color = primaryColor;
                activeBtn.classList.add('font-semibold');
                
                if (section === 'dashboard') renderDashboardSection();
                else if (section === 'users') renderUsersSection();
                else if (section === 'results') renderResultsSection();
                else if (section === 'questions') renderQuestionsSection();
                else if (section === 'settings') renderSettingsSection();
                else if (section === 'schedule') renderScheduleSection();
            }

            function showGuruSection(section) {
                currentGuruTab = section;
                const config = window.elementSdk?.config || defaultConfig;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                
                
                document.querySelectorAll('[id^="nav-"]').forEach(btn => {
                    btn.classList.remove('bg-blue-100', 'text-blue-800', 'font-semibold');
                    btn.style.backgroundColor = '';
                    btn.style.color = '';
                });
                
                const activeBtn = document.getElementById(`nav-${section}`);
                activeBtn.style.backgroundColor = `${primaryColor}15`;
                activeBtn.style.color = primaryColor;
                activeBtn.classList.add('font-semibold');
                
                if (section === 'dashboard') renderDashboardGuruSection();
                else if (section === 'questions') renderGuruQuestionsSection();
            }


            function renderDashboardSection() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const textColor = config.text_color || defaultConfig.text_color;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                
                const totalUsers = allUsers.length;
                const totalStudents = allUsers.filter(u => u.role === 'siswa').length;
                const totalQuestions = allQuestions.length;
                const totalExams = allExamResults.length;
                
                const avgScore = allExamResults.length > 0 
                    ? Math.round(allExamResults.reduce((sum, r) => sum + r.final_score, 0) / allExamResults.length)
                    : 0;
                
                const recentResults = [...allExamResults]
                    .reverse()   //sort((a, b) => new Date(b.exam_time) - new Date(a.exam_time))
                    .slice(0, 5);
                
                document.getElementById('adminContent').innerHTML = `
                    <div class="space-y-4 md:space-y-6">
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                            <div class="bg-white rounded-xl shadow p-4 md:p-5">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-gray-600 text-xs md:text-sm" style="font-family: ${customFont}, ${baseFontStack};">Total Pengguna</h3>
                                    <span class="text-xl md:text-2xl">ðŸ‘¥</span>
                                </div>
                                <p class="font-bold text-2xl md:text-3xl" style="font-family: ${customFont}, ${baseFontStack}; color: ${primaryColor};">${totalUsers}</p>
                                <p class="text-gray-500 text-xs mt-1" style="font-family: ${customFont}, ${baseFontStack};">${totalStudents} Siswa</p>
                            </div>
                            
                            <div class="bg-white rounded-xl shadow p-4 md:p-5">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-gray-600 text-xs md:text-sm" style="font-family: ${customFont}, ${baseFontStack};">Bank Soal</h3>
                                    <span class="text-xl md:text-2xl">ðŸ“</span>
                                </div>
                                <p class="font-bold text-green-500 text-2xl md:text-3xl" style="font-family: ${customFont}, ${baseFontStack};">${totalQuestions}</p>
                                <p class="text-gray-500 text-xs mt-1" style="font-family: ${customFont}, ${baseFontStack};">Soal Tersedia</p>
                            </div>
                            
                            <div class="bg-white rounded-xl shadow p-4 md:p-5">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-gray-600 text-xs md:text-sm" style="font-family: ${customFont}, ${baseFontStack};">Ujian Selesai</h3>
                                    <span class="text-xl md:text-2xl">ðŸ“Š</span>
                                </div>
                                <p class="font-bold text-purple-500 text-2xl md:text-3xl" style="font-family: ${customFont}, ${baseFontStack};">${totalExams}</p>
                                <p class="text-gray-500 text-xs mt-1" style="font-family: ${customFont}, ${baseFontStack};">Total Ujian</p>
                            </div>
                            
                            <div class="bg-white rounded-xl shadow p-4 md:p-5">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-gray-600 text-xs md:text-sm" style="font-family: ${customFont}, ${baseFontStack};">Rata-rata</h3>
                                    <span class="text-xl md:text-2xl">â­</span>
                                </div>
                                <p class="font-bold text-yellow-500 text-2xl md:text-3xl" style="font-family: ${customFont}, ${baseFontStack};">${avgScore}</p>
                                <p class="text-gray-500 text-xs mt-1" style="font-family: ${customFont}, ${baseFontStack};">Nilai Rata-rata</p>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow p-6">
                            <h3 class="font-bold mb-4" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px; color: ${textColor};">ðŸ† Hasil Ujian Terbaru</h3>
                            <div class="space-y-2">
                                ${recentResults.length > 0 ? recentResults.map((result) => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                        <div>
                                            <p class="font-semibold" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">${result.student_name}</p>
                                            <p class="text-gray-500 text-xs" style="font-family: ${customFont}, ${baseFontStack};">${result.exam_subject} - Kelas ${result.student_class}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-lg" style="font-family: ${customFont}, ${baseFontStack}; color: ${result.final_score >= 80 ? '#22c55e' : result.final_score >= 60 ? '#eab308' : '#ef4444'};">${result.final_score}</p>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-8 text-gray-400">
                                        <p style="font-family: ${customFont}, ${baseFontStack};">Belum ada hasil ujian</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderDashboardGuruSection() { //tampilan dashboard
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const textColor = config.text_color || defaultConfig.text_color;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                // Filter soal: Harus cocok Mapel DAN Kelas yang diajar guru
                const teacherQuestions = allQuestions.filter(q => {
                    const isRightSubject = q.subject === currentUser.subject;
                    const teachesThisGrade = currentUser.class && currentUser.class.includes(q.question_class.charAt(0)); 
                    return isRightSubject && teachesThisGrade;
                });

                const teacherTotalQuestions = teacherQuestions.length;
                
                
                
                const totalQuestions = allQuestions.length;
                const totalExams = allExamResults.length;
                
                
                const avgScore = allExamResults.length > 0 
                    ? Math.round(allExamResults.reduce((sum, r) => sum + r.final_score, 0) / allExamResults.length)
                    : 0;
                
                const recentResults = [...allExamResults]
                    .reverse() //sort((a, b) => new Date(b.exam_time) - new Date(a.exam_time))
                    .slice(0, 5);
                
                document.getElementById('guruContent').innerHTML = `
                    <div class="space-y-4 md:space-y-6">
                        <div class="grid grid-cols-2 lg:grid-cols-2 gap-2 md:gap-4">
                            
                            <div class="bg-white rounded-xl shadow p-4 md:p-5">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-gray-600 text-xs md:text-sm" style="font-family: ${customFont}, ${baseFontStack};">Bank Soal</h3>
                                    <span class="text-xl md:text-2xl">ðŸ“</span>
                                </div>
                                <p class="font-bold text-green-500 text-2xl md:text-3xl" style="font-family: ${customFont}, ${baseFontStack};">${totalQuestions}</p>
                                <p class="text-gray-500 text-xs mt-1" style="font-family: ${customFont}, ${baseFontStack};">Soal Tersedia</p>
                                <p class="font-bold text-green-500 text-2xl md:text-3xl" style="font-family: ${customFont}, ${baseFontStack};">${teacherTotalQuestions}</p>
                                <p class="text-gray-500 text-xs mt-1" style="font-family: ${customFont}, ${baseFontStack};">Soal Anda</p>
                                
                            </div>
                            
                            <div class="bg-white rounded-xl shadow p-4 md:p-5">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-gray-600 text-xs md:text-sm" style="font-family: ${customFont}, ${baseFontStack};">Ujian Selesai</h3>
                                    <span class="text-xl md:text-2xl">ðŸ“Š</span>
                                </div>
                                <p class="font-bold text-purple-500 text-2xl md:text-3xl" style="font-family: ${customFont}, ${baseFontStack};">${totalExams}</p>
                                <p class="text-gray-500 text-xs mt-1" style="font-family: ${customFont}, ${baseFontStack};">Total Ujian</p>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow p-6">
                            <h3 class="font-bold mb-4" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px; color: ${textColor};">ðŸ† Hasil Ujian Terbaru</h3>
                            <div class="space-y-2">
                                ${recentResults.length > 0 ? recentResults.map((result) => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                        <div>
                                            <p class="font-semibold" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">${result.student_name}</p>
                                            <p class="text-gray-500 text-xs" style="font-family: ${customFont}, ${baseFontStack};">${result.exam_subject} - Kelas ${result.student_class}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-lg" style="font-family: ${customFont}, ${baseFontStack}; color: ${result.final_score >= 80 ? '#22c55e' : result.final_score >= 60 ? '#eab308' : '#ef4444'};">${result.final_score}</p>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-8 text-gray-400">
                                        <p style="font-family: ${customFont}, ${baseFontStack};">Belum ada hasil ujian</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }
            

            function renderUsersSection() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const textColor = config.text_color || defaultConfig.text_color;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                
                document.getElementById('adminContent').innerHTML = `
                    <div class="space-y-6">
                        <div class="flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-3">
                            <h2 class="font-bold" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.5}px; color: ${textColor};">Data Pengguna</h2>
                            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                                <button onclick="showAddUserForm()" 
                                    class="w-full sm:w-auto px-4 py-3 rounded-xl text-white font-semibold hover:opacity-90 transition shadow-lg flex items-center justify-center gap-2"
                                    style="background: linear-gradient(135deg, ${primaryColor}, ${config.secondary_color || defaultConfig.secondary_color}); font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">
                                    <span class="text-lg">âž•</span>
                                    <span>Tambah Pengguna</span>
                                </button>
                                <button onclick="refreshTarget('users')" 
                                    class="w-full sm:w-auto px-4 py-3 bg-gray-600 rounded-xl text-white font-semibold hover:bg-gray-700 transition shadow-lg"
                                    style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">
                                    ðŸ”„ Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div id="userFormContainer" style="display: none;" class="bg-white rounded-2xl shadow-custom p-6"></div>
                        
                        <div class="bg-white rounded-2xl shadow-custom p-4 md:p-6">
                            <div class="overflow-x-auto -mx-4 md:mx-0">
                                <table class="w-full min-w-full">
                                    <thead>
                                        <tr class="border-b-2 border-gray-300">
                                            <th class="text-left p-4" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: ${textColor};">Foto</th>
                                            <th class="text-left p-4" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: ${textColor};">Username</th>
                                            <th class="text-left p-4" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: ${textColor};">Nama</th>
                                            <th class="text-left p-4" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: ${textColor};">Role</th>
                                            <th class="text-left p-4" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: ${textColor};">Kelas</th>
                                            <th class="text-left p-4" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: ${textColor};">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        ${allUsers.map(user => `
                                            <tr class="border-b border-gray-200 hover:bg-blue-50 transition">
                                                <td class="p-4">
                                                    ${user.photo && user.photo.trim() !== '' ? 
                                                        `<img src="${user.photo}" alt="${user.name}" class="w-10 h-10 rounded-full object-cover border-2 border-gray-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                        <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-xl" style="display:none;">ï¿½ï¿½</div>` 
                                                        : 
                                                        `<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-xl">ðŸ‘¤</div>`
                                                    }
                                                </td>
                                                <td class="p-4">
                                                    <span class="font-semibold" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">${user.username}</span>
                                                </td>
                                                <td class="p-4" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">${user.name}</td>
                                                <td class="p-4">
                                                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${user.role === 'admin' ? 'bg-purple-100 text-purple-800' : user.role === 'guru' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}" style="font-family: ${customFont}, ${baseFontStack};">
                                                        ${user.role === 'admin' ? 'ðŸ‘¨â€ðŸ’¼ Admin' : user.role === 'guru' ? 'ðŸ‘¨â€ðŸ« Guru' : 'ðŸ‘¨â€ðŸŽ“ Siswa'}
                                                    </span>
                                                </td>
                                                <td class="p-4">
                                                    <span class="font-semibold" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">${user.class || '-'}</span>
                                                </td>
                                                <td class="p-4">
                                                    <button onclick="deleteUser('${user.id}')" 
                                                        class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition shadow"
                                                        style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">
                                                        ðŸ—‘ï¸ Hapus
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                ${allUsers.length === 0 ? `
                                    <div class="text-center py-12">
                                        <p class="text-gray-400 text-xl" style="font-family: ${customFont}, ${baseFontStack};">Belum ada pengguna</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            function showAddUserForm() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                
                const container = document.getElementById('userFormContainer');
                container.style.display = 'block';
                container.innerHTML = `
                    <h3 class="font-bold mb-4" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px;">Tambah Pengguna Baru</h3>
                    <form id="addUserForm" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Username</label>
                            <input type="text" id="newUsername" required 
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Password</label>
                            <input type="password" id="newPassword" required 
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Nama Lengkap</label>
                            <input type="text" id="newName" required 
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Role</label>
                            <select id="newRole" required onchange="toggleClassField()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                                <option value="">Pilih Role</option>
                                <option value="admin">Admin</option>
                                <option value="siswa">Siswa</option>
                            </select>
                        </div>
                        <div id="classFieldContainer" style="display: none;">
                            <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Kelas</label>
                            <select id="newClass"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                                <option value="">Pilih Kelas</option>
                                ${generateClassOptions()}
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">URL Foto (Opsional)</label>
                            <input type="url" id="newPhoto" 
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                        </div>
                        <div class="col-span-2 flex gap-3">
                            <button type="submit" 
                                class="px-6 py-2 rounded-lg text-white font-semibold hover:opacity-90 transition"
                                style="background-color: ${primaryColor}; font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                                Simpan
                            </button>
                            <button type="button" onclick="hideAddUserForm()" 
                                class="px-6 py-2 bg-gray-500 rounded-lg text-white font-semibold hover:bg-gray-600 transition"
                                style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                                Batal
                            </button>
                        </div>
                    </form>
                `;
                
                document.getElementById('addUserForm').addEventListener('submit', addUser);
            }
            //untuk hasil nilai
            function generateClassOptions() {
                // 1. Ambil list kelas unik
                const uniqueClasses = [...new Set(allExamResults.map(item => item.student_class))].sort();            
                return uniqueClasses.map(c => {
                    // --- PEMBERSIHAN DATA ---
                    // Ubah data kelas (c) menjadi String dan buang spasi (trim)
                    const classValue = String(c || "").trim();
                    
                    // Ubah state yang dipilih menjadi String dan buang spasi (trim)
                    const selectedValue = String(filterState.class || "").trim();

                    // --- BANDINGKAN ---
                    // Jika nilainya sama persis, tambahkan atribut 'selected'
                    const isSelected = (classValue === selectedValue) ? 'selected' : '';

                    // Return HTML Option
                    return `<option value="${classValue}" ${isSelected}>${classValue}</option>`;
                }).join('');
            }

            //untuk tambah user
            function generateClassOptions() {
                let options = '';
                for (let grade = 7; grade <= 9; grade++) {
                    for (let classNum = 1; classNum <= 10; classNum++) {
                        options += `<option value="${grade}${classNum}">${grade}${classNum}</option>`;
                    }
                }
                return options;
            }

            function toggleClassField() {
                const role = document.getElementById('newRole').value;
                const classContainer = document.getElementById('classFieldContainer');
                
                if (role === 'siswa') {
                    classContainer.style.display = 'block';
                    document.getElementById('newClass').required = true;
                } else {
                    classContainer.style.display = 'none';
                    document.getElementById('newClass').required = false;
                }
            }

            async function addUser(e) {
                e.preventDefault();
                
                const username = document.getElementById('newUsername').value;
                const password = document.getElementById('newPassword').value;
                const name = document.getElementById('newName').value;
                const role = document.getElementById('newRole').value;
                const classValue = role === 'siswa' ? document.getElementById('newClass').value : '';
                const photo = document.getElementById('newPhoto').value;
                
                const userData = {
                    username: username,
                    password: password,
                    name: name,
                    role: role,
                    class: classValue,
                    photo: photo
                };
                
                const success = await saveUserToSheet(userData);
                
                if (success) {
                    hideAddUserForm();
                    showToast('Pengguna berhasil ditambahkan!', 'success');
                    renderUsersSection();
                }
            }

            function hideAddUserForm() {
                document.getElementById('userFormContainer').style.display = 'none';
            }

            async function deleteUser(userId) {
                const user = allUsers.find(u => u.id === userId);
                if (!user) return;
                
                const confirmDiv = document.createElement('div');
                confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                confirmDiv.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-sm">
                        <p class="mb-4">Yakin ingin menghapus pengguna ini?</p>
                        <div class="flex gap-3">
                            <button onclick="confirmDeleteUser('${userId}')" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Hapus</button>
                            <button onclick="this.closest('div.fixed').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Batal</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmDiv);
            }

            async function confirmDeleteUser(userId) {
                document.querySelector('div.fixed').remove();
                
                const success = await deleteUserFromSheet(userId);
                
                if (success) {
                    showToast('Pengguna berhasil dihapus!', 'success');
                    renderUsersSection();
                }
            }

            function renderResultsSection() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const textColor = config.text_color || defaultConfig.text_color;

                const filteredData = getProcessedData();

                // --- 2. CEK APAKAH ELEMEN SUDAH ADA? (INTI SOLUSI) ---
                const existingTableBody = document.getElementById('resultsTableBody');

                // --- BAGIAN A: RENDER WADAH (Hanya Sekali) ---
                // Jika 'resultsTableBody' belum ada, berarti ini pertama kali buka tab.
                // Kita buat Dropdown, Tombol, dan Header Tabel di sini.
                if (!existingTableBody) {
                    
                    // Siapkan opsi dropdown saat inisialisasi awal
                    const uniqueClasses = [...new Set(allExamResults.map(item => String(item.student_class || "").trim()))].sort();
                    const classOptionsHTML = uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
                    const subjectOptionsHTML = SUBJECTS.map(s => `<option value="${s}">${s}</option>`).join('');

                    document.getElementById('adminContent').innerHTML = `
                        <div class="bg-white rounded-xl shadow-custom p-4 md:p-6">
                            <h2 class="font-bold mb-4 md:mb-6 text-lg md:text-xl" style="font-family: ${customFont}, ${baseFontStack}; color: ${textColor};">Hasil Ujian</h2>
                            
                            <div class="mb-4 md:mb-6 flex flex-col sm:flex-row flex-wrap gap-2 md:gap-3">
                                
                                <select id="filterClass" onchange="updateFilter('class', this.value)"
                                    class="w-full sm:w-auto px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                    style="font-family: ${customFont}, ${baseFontStack};">
                                    <option value="">Semua Kelas</option>
                                    ${classOptionsHTML}
                                </select>

                                <select id="filterSubject" onchange="updateFilter('subject', this.value)"
                                    class="w-full sm:w-auto px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                    style="font-family: ${customFont}, ${baseFontStack};">
                                    <option value="">Semua Mapel</option>
                                    ${subjectOptionsHTML}
                                </select>

                                <select id="filterSort" onchange="updateFilter('sortBy', this.value)"
                                    class="w-full sm:w-auto px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                    style="font-family: ${customFont}, ${baseFontStack};">
                                    <option value="time_desc">ðŸ•’ Terkini</option>
                                    <option value="score_desc">ðŸ† Nilai Tertinggi</option>
                                    <option value="score_asc">ðŸ“‰ Nilai Terendah</option>
                                    <option value="name_asc">ðŸ”¤ Nama (A-Z)</option>
                                    <option value="name_desc">ðŸ”  Nama (Z-A)</option>
                                </select>

                                <div class="flex gap-2 w-full sm:w-auto">
                                    <button onclick="downloadExcel()" class="flex-1 sm:flex-none px-4 py-2 text-sm bg-green-500 rounded-lg text-white font-semibold hover:bg-green-600 transition" style="font-family: ${customFont}, ${baseFontStack};">
                                        ðŸ“Š Download Hasil Excel
                                    </button> 
                                    <button onclick="refreshTarget('examResults')" class="flex-1 sm:flex-none px-4 py-2 text-sm bg-gray-600 rounded-lg text-white font-semibold hover:bg-gray-700 transition" style="font-family: ${customFont}, ${baseFontStack};">
                                        ðŸ”„ Refresh
                                    </button>
                                </div>
                            </div>
                            
                            <div class="hidden md:block overflow-x-auto -mx-4 md:mx-0">
                                <table class="w-full min-w-full">
                                    <thead>
                                        <tr class="border-b-2 border-gray-300">
                                            <th class="text-left p-3">Nama</th>
                                            <th class="text-left p-3">Kelas</th>
                                            <th class="text-left p-3">Mapel</th>
                                            <th class="text-left p-3">Waktu</th>
                                            <th class="text-left p-3">Nilai</th>
                                            <th class="text-left p-3">Pelanggaran</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resultsTableBody"></tbody>
                                </table>
                            </div>
                            
                            <div class="md:hidden space-y-3" id="resultsMobileView"></div>
                        </div>
                    `;

                    // SET NILAI AWAL STATE (Hanya saat render pertama)
                    const dropClass = document.getElementById('filterClass');
                    const dropSubject = document.getElementById('filterSubject');
                    const dropSort = document.getElementById('filterSort');

                    if (dropClass) dropClass.value = String(filterState.class || "").trim();
                    if (dropSubject) dropSubject.value = String(filterState.subject || "").trim();
                    if (dropSort) dropSort.value = filterState.sortBy;
                }

                // --- BAGIAN B: UPDATE ISI DATA (Berjalan Terus) ---
                // Bagian ini hanya menyentuh <tbody> dan div mobile, TIDAK menyentuh Dropdown.
                // Sehingga dropdown aman dan tidak akan tertutup sendiri.

                const tableBody = document.getElementById('resultsTableBody');
                const mobileView = document.getElementById('resultsMobileView');

                // 1. Update Tabel Desktop
                if (tableBody) {
                    if (filteredData.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-12 text-gray-400">Data tidak ditemukan</td></tr>`;
                    } else {
                        tableBody.innerHTML = filteredData.map(result => `
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="p-3" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">${result.student_name}</td>
                                <td class="p-3" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">${result.student_class}</td>
                                <td class="p-3" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">${result.exam_subject}</td>
                                <td class="p-3" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">${result.exam_time ? (!isNaN(new Date(result.exam_time)) ? new Date(result.exam_time).toLocaleString('id-ID') : result.exam_time) : '-'}</td>
                                <td class="p-3 font-bold" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;" style="color: ${result.final_score >= 80 ? '#166534' : result.final_score >= 60 ? '#854d0e' : '#991b1b'};">${result.final_score}</td>
                                <td class="p-3">
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${result.violations > 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                        ${result.violations > 0 ? `ðŸš¨ ${result.violations}x` : 'âœ… 0'}
                                    </span>
                                </td>
                            </tr>
                        `).join('');
                    }
                }

                // 2. Update Mobile View
                if (mobileView) {
                    if (filteredData.length === 0) {
                        mobileView.innerHTML = `<div class="text-center py-12"><p class="text-gray-400">Data tidak ditemukan</p></div>`;
                    } else {
                        mobileView.innerHTML = filteredData.map(result => `
                            <div class="border-2 border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <h3 class="font-bold text-base mb-1">${result.student_name}</h3>
                                        <p class="text-sm text-gray-600">Kelas ${result.student_class}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold" style="font-family: ${customFont}, ${baseFontStack}; color: ${result.final_score >= 80 ? '#166534' : result.final_score >= 60 ? '#854d0e' : '#991b1b'};">${result.final_score}</div>
                                        <p class="text-sm text-gray-500">Nilai</p>
                                    </div>
                                </div>
                                <div class="pt-3 border-t border-gray-200 text-xs space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">Mapel</span>
                                        <span class="font-medium">${result.exam_subject}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">Waktu</span>
                                        <span class="font-medium">${result.exam_time ? (!isNaN(new Date(result.exam_time)) ? new Date(result.exam_time).toLocaleString('id-ID') : result.exam_time) : '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">Pelanggaran</span>
                                        <span class="${result.violations > 0 ? 'text-red-600 font-bold' : 'text-green-600'}">${result.violations > 0 ? result.violations + 'x' : 'Nihil'}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            }

            function downloadExcel() {
                if (!allExamResults || allExamResults.length === 0) {
                    showToast('Tidak ada data untuk didownload', 'error');
                    return;
                }
                const dataToExport = getProcessedData();
                if (dataToExport.length === 0) {
                    alert("Tidak ada data yang sesuai filter untuk diunduh.");
                    return;
                }

                // 1. Siapkan data
                const formattedData = dataToExport.map((item, index) => ({
                    "No": index + 1,
                    "Nama Siswa": item.student_name,
                    "Kelas": item.student_class,
                    "Mata Pelajaran": item.exam_subject,
                    "Skor": item.final_score,
                    //"Waktu Selesai": item.exam_time ? new Date(item.exam_time).toLocaleString('id-ID') : '-',
                    "Pelanggaran": item.violations || 0
                }));

                // 3. Buat Nama File Dinamis
                // Contoh: "Hasil_Ujian_7A.xlsx" atau "Hasil_Ujian_Semua.xlsx"
                let fileName = "Hasil_Ujian";
                if (filterState.class) fileName += `_Kelas_${filterState.class}`;
                if (filterState.subject) fileName += `_${filterState.subject}`;
                fileName += ".xlsx";

                // 4. Proses Pembuatan File Excel (SheetJS)
                const worksheet = XLSX.utils.json_to_sheet(formattedData);
                const workbook = XLSX.utils.book_new();

                // Mengatur lebar kolom (Opsional, agar rapi)
                const wscols = [
                    {wch: 5},  // No
                    {wch: 30}, // Nama
                    {wch: 10}, // Kelas
                    {wch: 20}, // Mapel
                    {wch: 10}, // Nilai
                    //{wch: 25}, // Waktu
                    {wch: 15}  // Pelanggaran
                ];
                worksheet['!cols'] = wscols;

                XLSX.utils.book_append_sheet(workbook, worksheet, "Hasil Ujian");
                XLSX.writeFile(workbook, fileName);            
            }

            function renderQuestionsSection() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const textColor = config.text_color || defaultConfig.text_color;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                
                const questionsByGrade = {
                    '7': allQuestions.filter(q => q.question_class.startsWith('7')),
                    '8': allQuestions.filter(q => q.question_class.startsWith('8')),
                    '9': allQuestions.filter(q => q.question_class.startsWith('9'))
                };
                
                document.getElementById('adminContent').innerHTML = `
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h2 class="font-bold" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.25}px; color: ${textColor};">Bank Soal</h2>
                            <div class="flex gap-2">
                                <button onclick="showAddQuestionForm()" 
                                    class="px-4 py-2 rounded-lg text-white font-semibold hover:opacity-90 transition text-sm"
                                    style="background-color: ${primaryColor}; font-family: ${customFont}, ${baseFontStack};">
                                    âž• Tambah Soal
                                </button>
                                <button onclick="refreshTarget('questions')" 
                                    class="px-4 py-2 bg-gray-600 rounded-lg text-white font-semibold hover:bg-gray-700 transition text-sm"
                                    style="font-family: ${customFont}, ${baseFontStack};">
                                    ðŸ”„ Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div id="questionFormContainer" style="display: none;" class="bg-white rounded-lg shadow p-4"></div>
                        
                        <div class="space-y-4">
                            ${['7', '8', '9'].map(grade => `
                                <div class="bg-white rounded-lg shadow p-4">
                                    <div class="flex items-center justify-between mb-3 pb-2 border-b-2 border-gray-200">
                                        <h3 class="font-bold text-lg" style="font-family: ${customFont}, ${baseFontStack}; color: ${primaryColor};">
                                            ðŸ“š Kelas ${grade} <span class="text-sm font-normal text-gray-600">(${questionsByGrade[grade].length} soal)</span>
                                        </h3>
                                    </div>
                                    <div class="space-y-2" id="questionsList${grade}">
                                        ${questionsByGrade[grade].length > 0 ? questionsByGrade[grade].map(q => `
                                            <div onclick='showQuestionDetail(${JSON.stringify(q).replace(/'/g, "&apos;")})' 
                                                class="border border-gray-200 rounded-lg p-3 hover:bg-blue-50 cursor-pointer transition">
                                                <div class="flex justify-between items-start gap-3">
                                                    <div class="flex-1 min-w-0">
                                                        <div class="flex gap-2 mb-2 flex-wrap">
                                                            <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-semibold">${q.subject}</span>
                                                            <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-semibold">${getQuestionTypeLabel(q.question_type)}</span>
                                                        </div>
                                                        <p class="text-gray-800 text-sm line-clamp-2">${q.question_text.replace(/<[^>]*>/g, '')}</p>
                                                    </div>
                                                    <button onclick="event.stopPropagation(); editQuestion('${q.id}')" 
                                                        class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition text-xs flex items-center gap-1 shadow-sm">
                                                        âœï¸ <span class="hidden sm:inline">Edit</span>
                                                    </button>
                                                    <button onclick="event.stopPropagation(); deleteQuestion('${q.id}')" 
                                                        class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition text-xs flex-shrink-0">
                                                        ðŸ—‘ï¸ Hapus
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('') : `
                                            <div class="text-center py-8 text-gray-400">
                                                <p style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Belum ada soal untuk kelas ${grade}</p>
                                            </div>
                                        `}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            function renderGuruQuestionsSection() { // tambah soal
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const textColor = config.text_color || defaultConfig.text_color;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                
                const questionsByGrade = {
                    '7': allQuestions.filter(q => q.question_class.startsWith('7')),
                    '8': allQuestions.filter(q => q.question_class.startsWith('8')),
                    '9': allQuestions.filter(q => q.question_class.startsWith('9'))
                };
                
                document.getElementById('guruContent').innerHTML = `
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h2 class="font-bold" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.25}px; color: ${textColor};">Bank Soal</h2>
                            <div class="flex gap-2">
                                <button onclick="showGuruAddQuestionForm()" 
                                    class="px-4 py-2 rounded-lg text-white font-semibold hover:opacity-90 transition text-sm"
                                    style="background-color: ${primaryColor}; font-family: ${customFont}, ${baseFontStack};">
                                    âž• Tambah Soal
                                </button>
                                <button onclick="refreshTarget('questions')" 
                                    class="px-4 py-2 bg-gray-600 rounded-lg text-white font-semibold hover:bg-gray-700 transition text-sm"
                                    style="font-family: ${customFont}, ${baseFontStack};">
                                    ðŸ”„ Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div id="questionFormContainer" style="display: none;" class="bg-white rounded-lg shadow p-4"></div>
                        
                        <div class="space-y-4">
                            ${['7', '8', '9'].map(grade => `
                                <div class="bg-white rounded-lg shadow p-4">
                                    <div class="flex items-center justify-between mb-3 pb-2 border-b-2 border-gray-200">
                                        <h3 class="font-bold text-lg" style="font-family: ${customFont}, ${baseFontStack}; color: ${primaryColor};">
                                            ðŸ“š Kelas ${grade} <span class="text-sm font-normal text-gray-600">(${questionsByGrade[grade].length} soal)</span>
                                        </h3>
                                    </div>
                                    <div class="space-y-2" id="questionsList${grade}">
                                        ${questionsByGrade[grade].length > 0 ? questionsByGrade[grade].map(q => {

                                            // 1. Cek Mapel: Apakah mapel soal sama dengan mapel guru?
                                            const isRightSubject = q.subject === currentUser.subject;
                                            // 2. Cek Kelas: Apakah grade saat ini ada dalam daftar kelas yang diajar guru?
                                            // Asumsi: currentUser.class berisi string seperti "7" atau array ["7", "8"]
                                            const teachesThisGrade = currentUser.class && currentUser.class.includes(grade);
                                            // Tombol hapus HANYA muncul jika Mapel cocok DAN Guru memang mengajar kelas tersebut
                                            const isOwner = isRightSubject && teachesThisGrade;
            
                                            return `
                                            <div onclick='showQuestionDetail(${JSON.stringify(q).replace(/'/g, "&apos;")})'
                                                class="border border-gray-200 rounded-lg p-3 ${isOwner ? 'hover:bg-gray-50' : 'bg-gray-50/50'} transition cursor-pointer">
                                                    <div class="flex justify-between items-start gap-3">
                                                        <div class="flex-1 min-w-0">
                                                            <div class="flex gap-2 mb-2 flex-wrap">
                                                                <span class="px-2 py-1 ${isOwner ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-600'} rounded text-xs font-semibold">
                                                                    ${q.subject}
                                                                </span>
                                                                <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-semibold">
                                                                    ${getQuestionTypeLabel(q.question_type)}
                                                                </span>
                                                            </div>
                                                            <p class="text-gray-800 text-sm break-words">${q.question_text}</p>
                                                        </div>
                        
                                                        ${isOwner ? `
                                                            <button onclick="event.stopPropagation(); editQuestion('${q.id}')" 
                                                                class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition text-xs flex items-center gap-1 shadow-sm">
                                                                âœï¸ <span class="hidden sm:inline">Edit</span>
                                                            </button>
                                                            <button onclick="event.stopPropagation(); deleteQuestion('${q.id}')" 
                                                                class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition text-xs flex-shrink-0">
                                                                ðŸ—‘ï¸ Hapus
                                                            </button>
                                                        ` : '<span class="text-xs text-gray-400 italic self-center">Read Only</span>'}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('') : `
                                            <div class="text-center py-8 text-gray-400">
                                                <p>Belum ada soal untuk kelas ${grade}</p>
                                            </div>
                                        `}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            function showQuestionDetail(q) {
                // 1. AMBIL DAN DECODE KUNCI JAWABAN
                let kunciRaw = '';
                try {
                    kunciRaw = q.security_token ? atob(q.security_token).trim() : String(q.correct_answer || q.answer_key || '').trim();
                } catch (e) { 
                    kunciRaw = String(q.correct_answer || '').trim(); 
                }

                // 2. FUNGSI PEMBERSIH BARU (LEBIH AMAN)
                const cleanText = (str) => {
                    if (str === null || str === undefined) return "";
                    str = String(str);
                    let tmp = document.createElement("DIV");
                    tmp.innerHTML = str;
                    let text = tmp.textContent || tmp.innerText || "";
                    return text.toUpperCase().replace(/\s+/g, ' ').trim();
                };

                const kunciBersihTotal = cleanText(kunciRaw);
                const daftarKunciArray = kunciBersihTotal.split(',').map(k => k.trim());

                // 3. PROSES OPSI JAWABAN
                let optionsArray = [];
                try {
                    if (typeof q.options === 'string' && q.options.trim() !== '') {
                        optionsArray = JSON.parse(q.options);
                    } else if (Array.isArray(q.options)) {
                        optionsArray = q.options;
                    }
                } catch (e) { optionsArray = []; }

                let contentHtml = '';

                // CASE A: JIKA SOAL PILIHAN GANDA / KOMPLEKS
                if (optionsArray && optionsArray.length > 0) {
                    contentHtml += '<div class="space-y-2 mt-3 text-left">';
                    
                    // LOGIKA BARU: Cek apakah ada opsi yang identik 100% dengan kunci jawaban (Mencegah bug 23,5 vs 23)
                    const hasExactTextMatch = optionsArray.some(opt => cleanText(opt) === kunciBersihTotal);

                    optionsArray.forEach((opt, idx) => {
                        const label = String.fromCharCode(65 + idx).toUpperCase(); 
                        const opsiBersih = cleanText(opt);
                        
                        let isCorrect = false;
                        
                        if (opsiBersih !== "") {
                            if (hasExactTextMatch) {
                                // Jika ada match 100%, JANGAN gunakan pecahan koma. Fokus ke Exact Match!
                                if (opsiBersih === kunciBersihTotal) {
                                    isCorrect = true;
                                }
                            } else {
                                // Mode Fleksibel: Digunakan HANYA jika kuncinya format "A, B" atau "1, 2"
                                if (daftarKunciArray.includes(opsiBersih)) {
                                    isCorrect = true;
                                } else if (kunciBersihTotal === label || daftarKunciArray.includes(label)) {
                                    isCorrect = true;
                                } else if (daftarKunciArray.includes(String(idx)) || daftarKunciArray.includes(String(idx + 1))) {
                                    isCorrect = true;
                                }
                            }
                        }

                        contentHtml += `
                            <div class="px-3 py-2 rounded border-2 transition-all ${isCorrect ? 'border-green-500 bg-green-50 shadow-sm' : 'border-gray-200 bg-white'}">
                                <div class="flex items-center gap-3">
                                    <span class="w-7 h-7 flex-shrink-0 flex items-center justify-center rounded-md font-bold text-xs ${isCorrect ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-500'}">
                                        ${label}
                                    </span>
                                    <div class="flex-1 text-sm ${isCorrect ? 'text-green-900 font-bold' : 'text-gray-700'}">
                                        ${opt}
                                    </div>
                                    ${isCorrect ? '<b class="text-green-600 ml-2 text-xl">âœ“</b>' : ''}
                                </div>
                            </div>`;
                    });
                    contentHtml += '</div>';
                } 
                // CASE B: JIKA SOAL ISIAN SINGKAT
                else {
                    contentHtml = `
                        <div class="mt-4">
                            <div class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-widest">Jawaban Benar:</div>
                            <div class="p-4 bg-green-100 border-2 border-green-500 rounded-xl text-green-900 font-bold text-lg text-center shadow-inner">
                                ${kunciRaw}
                            </div>
                        </div>`;
                }

                // 4. TAMPILKAN MODAL
                Swal.fire({
                    title: '<div class="text-lg font-bold text-gray-700">Detail Soal</div>',
                    html: `
                        <div class="text-left">
                            <div class="mb-4 p-3 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
                                <div class="text-[10px] font-bold text-blue-400 uppercase mb-1">Pertanyaan:</div>
                                <div class="text-gray-800 text-sm leading-relaxed" style="white-space: pre-wrap;">${q.question_text}</div>
                                ${q.question_image ? `<img src="${q.question_image}" class="mt-3 rounded-lg max-w-full h-auto mx-auto border shadow-sm block">` : ''}
                            </div>                            
                            
                            <div class="flex justify-between items-center mb-1">
                                <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Opsi Jawaban:</div>
                                <div class="text-[9px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-bold uppercase">Kunci: ${kunciRaw}</div>
                            </div>

                            ${contentHtml}

                            <div class="mt-4 p-2 bg-gray-50 rounded border border-gray-100 text-[10px] text-gray-500 flex justify-between uppercase font-bold tracking-tighter">
                                <span>Kelas: ${q.question_class || '-'}</span>
                                <span>Mapel: ${q.subject || '-'}</span>
                            </div>
                        </div>`,
                    width: '550px',
                    confirmButtonText: 'Tutup',
                    confirmButtonColor: '#2563eb',
                    heightAuto: false
                });
            }

            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz7GPdsc6CXcY31ZSA1XjnL7NobL1mDYkVg-ewMptXMqCXm001ri7a9mgNBQcG52Bgq/exec";
            async function editQuestion(id) {
                const q = allQuestions.find(x => x.id === id);
                if (!q) { 
                    Swal.fire('Error', 'Data soal tidak ditemukan.', 'error'); 
                    return; 
                }

                // 1. Identifikasi Kunci Jawaban
                let rawKey = q.correct_answer || q.security_token || q.answer_key || q.key || "";
                rawKey = String(rawKey).trim();

                // 2. Decode Base64
                let decodedKey = rawKey;
                try {
                    if (/^[A-Za-z0-9+/=]+$/.test(rawKey) && rawKey.length % 4 === 0 && rawKey.length > 0) {
                        decodedKey = decodeURIComponent(escape(window.atob(rawKey)));
                    }
                } catch (e) { decodedKey = rawKey; }

                // 3. Parsing Opsi
                let parsedOptions = ["", "", "", ""];
                try {
                    if (Array.isArray(q.options)) {
                        parsedOptions = q.options;
                    } else if (typeof q.options === 'string') {
                        let cleanOpt = q.options.trim();
                        if (cleanOpt.startsWith('[')) parsedOptions = JSON.parse(cleanOpt);
                    }
                } catch (e) { }

                const safeText = q.question_text || "";

                Swal.fire({
                    title: 'âœï¸ Edit Soal',
                    width: '800px',
                    html: `
                        <style>
                            .editor-container { cursor: text; transition: all 0.2s; border-width: 2px !important; }
                            .editor-container:focus-within { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
                            .ql-editor { min-height: 80px; font-size: 15px; }
                            .ql-container.ql-snow { border: none !important; }
                            .ql-toolbar.ql-snow { border: none !important; border-bottom: 1px solid #f0f0f0 !important; background: #fafafa; border-radius: 8px 8px 0 0; }
                            
                            /* Warna Identitas */
                            .box-soal { border-color: #3b82f6 !important; background-color: #eff6ff; }
                            .box-a { border-color: #10b981 !important; background-color: #ecfdf5; }
                            .box-b { border-color: #ef4444 !important; background-color: #fef2f2; }
                            .box-c { border-color: #f59e0b !important; background-color: #fffbeb; }
                            .box-d { border-color: #8b5cf6 !important; background-color: #f5f3ff; }
                            
                            label.title-opt { padding: 4px 12px; border-radius: 20px; color: white; display: inline-block; margin-bottom: 6px; }
                        </style>

                        <div class="text-left space-y-6" style="max-height: 75vh; overflow-y: auto; padding: 15px;">
                            <div class="grid grid-cols-3 gap-4 bg-gray-100 p-4 rounded-xl shadow-sm">
                                <div>
                                    <label class="block text-xs font-black text-gray-500 uppercase mb-1">Jenjang Kelas</label>
                                    <select id="edit-class" class="w-full p-2 border-0 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500">
                                        <option value="7" ${q.question_class == '7' ? 'selected' : ''}>Kelas 7</option>
                                        <option value="8" ${q.question_class == '8' ? 'selected' : ''}>Kelas 8</option>
                                        <option value="9" ${q.question_class == '9' ? 'selected' : ''}>Kelas 9</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-gray-500 uppercase mb-1">Mata Pelajaran</label>
                                    <select id="edit-subject" class="w-full p-2 border-0 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500">
                                        ${(typeof SUBJECTS !== 'undefined' ? SUBJECTS : ['Matematika', 'IPA', 'Bahasa Indonesia', 'Bahasa Inggris', 'PKN', 'IPS', 'Informatika']).map(s => 
                                            `<option value="${s}" ${s === q.subject ? 'selected' : ''}>${s}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-purple-600 uppercase mb-1">Tipe Soal</label>
                                    <select id="edit-type" class="w-full p-2 border-2 border-purple-200 rounded-lg shadow-sm font-bold focus:border-purple-500">
                                        <option value="pilihan_ganda" ${q.question_type === 'pilihan_ganda' ? 'selected' : ''}>Pilihan Ganda</option>
                                        <option value="pilihan_ganda_kompleks" ${q.question_type === 'pilihan_ganda_kompleks' ? 'selected' : ''}>PG Kompleks</option>
                                        <option value="benar_salah" ${q.question_type === 'benar_salah' ? 'selected' : ''}>Benar / Salah</option>
                                        <option value="isian_singkat" ${q.question_type === 'isian_singkat' ? 'selected' : ''}>Isian</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="title-opt bg-blue-600 text-xs font-bold uppercase">Pertanyaan</label>
                                <div id="edit-q-text" class="editor-container box-soal bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="min-height: 120px;"></div>
                            </div>
                            
                            <div id="edit-options-wrapper" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="title-opt bg-amber-500 text-xs font-bold uppercase">Opsi A</label>
                                        <div id="edit-opt-0" class="editor-container box-c bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="height: 100px;"></div>
                                    </div>
                                    <div>
                                        <label class="title-opt bg-amber-500 text-xs font-bold uppercase">Opsi B</label>
                                        <div id="edit-opt-1" class="editor-container box-c bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="height: 100px;"></div>
                                    </div>
                                    <div>
                                        <label class="title-opt bg-amber-500 text-xs font-bold uppercase">Opsi C</label>
                                        <div id="edit-opt-2" class="editor-container box-c bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="height: 100px;"></div>
                                    </div>
                                    <div>
                                        <label class="title-opt bg-amber-500 text-xs font-bold uppercase">Opsi D</label>
                                        <div id="edit-opt-3" class="editor-container box-c bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="height: 100px;"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 p-4 border-t-2 border-green-500 bg-green-50 rounded-xl shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div class="flex-shrink-0">
                                    <label class="text-sm font-black text-green-700 flex items-center">
                                        <span class="mr-2 text-lg">âœ…</span> KUNCI JAWABAN:
                                    </label>
                                </div>

                                <div id="edit-key-dropdown-container" class="flex-grow max-w-xs">
                                    <select id="edit-correct-opt" class="w-full p-2 border-2 border-green-300 rounded-lg text-lg font-black text-green-800 shadow-sm focus:border-green-500 outline-none">
                                        <option value="0">A</option><option value="1">B</option>
                                        <option value="2">C</option><option value="3">D</option>
                                    </select>
                                </div>

                                <div id="edit-key-manual-container" class="flex-grow max-w-md" style="display: none;">
                                    <input type="text" id="edit-manual-key" class="w-full p-2 border-2 border-gray-300 rounded-lg font-bold focus:border-blue-500 shadow-sm" value="${decodedKey.replace(/"/g, '&quot;')}" placeholder="Ketik jawaban...">
                                </div>
                            </div>
                        </div>
                    `,
                    didOpen: () => {
                        const configMini = { modules: { toolbar: [['bold', 'italic', 'underline'], ['image', 'formula'], ['clean']] }, theme: 'snow' };

                        window.editEditors = {
                            question: new Quill('#edit-q-text', configMini),
                            opt0: new Quill('#edit-opt-0', configMini),
                            opt1: new Quill('#edit-opt-1', configMini),
                            opt2: new Quill('#edit-opt-2', configMini),
                            opt3: new Quill('#edit-opt-3', configMini)
                        };

                        window.editEditors.question.root.innerHTML = safeText;
                        window.editEditors.opt0.root.innerHTML = parsedOptions[0] || '';
                        window.editEditors.opt1.root.innerHTML = parsedOptions[1] || '';
                        window.editEditors.opt2.root.innerHTML = parsedOptions[2] || '';
                        window.editEditors.opt3.root.innerHTML = parsedOptions[3] || '';

                        // Klik fokus otomatis pada kotak
                        Object.keys(window.editEditors).forEach(key => {
                            window.editEditors[key].container.addEventListener('click', () => { window.editEditors[key].focus(); });
                        });

                        // Logika Dropdown Otomatis (Tetap Sama)
                        if (['pilihan_ganda', 'benar_salah'].includes(q.question_type)) {
                            const normalize = (str) => {
                                if (!str) return "";
                                let tmp = document.createElement("DIV");
                                tmp.innerHTML = str;
                                return (tmp.textContent || tmp.innerText || "").replace(/\s+/g, '').toLowerCase();
                            };

                            const targetDecoded = normalize(decodedKey);
                            const targetRaw = normalize(rawKey);
                            let foundIndex = -1;

                            for (let i = 0; i < 4; i++) {
                                const optNorm = normalize(parsedOptions[i] || "");
                                if ((optNorm === targetDecoded && targetDecoded.length > 0) || (optNorm === targetRaw && targetRaw.length > 0)) {
                                    foundIndex = i; break;
                                }
                            }

                            if (foundIndex === -1) {
                                if (['0','1','2','3'].includes(decodedKey)) foundIndex = parseInt(decodedKey);
                                else if (['A','B','C','D'].includes(decodedKey.toUpperCase())) foundIndex = decodedKey.toUpperCase().charCodeAt(0) - 65;
                            }
                            document.getElementById('edit-correct-opt').value = (foundIndex === -1) ? 0 : foundIndex;
                        }

                        const typeSelect = document.getElementById('edit-type');
                        const toggleUI = () => {
                            const val = typeSelect.value;
                            const isBS = val === 'benar_salah'; // Identifikasi tipe Benar/Salah
                            const isSimple = ['pilihan_ganda', 'benar_salah'].includes(val);
                            
                            // 1. Sembunyikan Opsi C dan D jika tipe Benar/Salah
                            // Cari elemen pembungkus Opsi C dan D (index 2 dan 3)
                            const optContainers = [
                                document.getElementById('edit-opt-0').parentElement,
                                document.getElementById('edit-opt-1').parentElement,
                                document.getElementById('edit-opt-2').parentElement,
                                document.getElementById('edit-opt-3').parentElement
                            ];

                            if (isBS) {
                                optContainers[2].style.display = 'none'; // Sembunyikan C
                                optContainers[3].style.display = 'none'; // Sembunyikan D
                            } else {
                                optContainers[2].style.display = 'block';
                                optContainers[3].style.display = 'block';
                            }

                            // 2. Sembunyikan pilihan C dan D di Dropdown Kunci Jawaban
                            const dropOptions = document.getElementById('edit-correct-opt').options;
                            dropOptions[2].style.display = isBS ? 'none' : 'block';
                            dropOptions[3].style.display = isBS ? 'none' : 'block';

                            // Logika original Anda tetap berjalan
                            document.getElementById('edit-options-wrapper').style.display = (isSimple || val === 'pilihan_ganda_kompleks') ? 'block' : 'none';
                            document.getElementById('edit-key-dropdown-container').style.display = isSimple ? 'block' : 'none';
                            document.getElementById('edit-key-manual-container').style.display = isSimple ? 'none' : 'block';
                        };

                        typeSelect.addEventListener('change', toggleUI);
                        toggleUI();
                    },
                    showCancelButton: true,
                    confirmButtonText: 'ðŸ’¾ Update',
                    confirmButtonColor: '#10B981',
                    preConfirm: async () => {
                        const qClass = document.getElementById('edit-class').value;
                        const qSubject = document.getElementById('edit-subject').value;
                        const qType = document.getElementById('edit-type').value;

                        const processEditor = async (editorInstance) => {
                            const images = editorInstance.root.querySelectorAll('img');
                            for (let img of images) {
                                if (img.src.startsWith('data:image') && typeof compressImage === 'function') {
                                    img.src = await compressImage(img.src);
                                }
                            }
                            return editorInstance.root.innerHTML;
                        };

                        Swal.showLoading();

                        try {
                            const qText = await processEditor(window.editEditors.question);
                            let finalOptions = [];
                            let finalKey = "";

                            // 1. Ambil semua input dari 4 editor terlebih dahulu
                            let rawOptions = [
                                await processEditor(window.editEditors.opt0),
                                await processEditor(window.editEditors.opt1),
                                await processEditor(window.editEditors.opt2),
                                await processEditor(window.editEditors.opt3)
                            ];

                            if (['pilihan_ganda', 'benar_salah'].includes(qType)) {
                                // PERBAIKAN: Jika benar_salah, potong array agar hanya sisa index 0 dan 1 (A & B)
                                finalOptions = (qType === 'benar_salah') ? rawOptions.slice(0, 2) : rawOptions;
                                
                                // Ambil kunci berdasarkan index dropdown
                                finalKey = finalOptions[document.getElementById('edit-correct-opt').value];
                            } else {
                                if (qType === 'pilihan_ganda_kompleks') {
                                    finalOptions = rawOptions;
                                    let rawIn = document.getElementById('edit-manual-key').value;
                                    finalKey = rawIn.toUpperCase().replace(/\s+/g, '').split(',').filter(k => k !== '').join(',');
                                } else {
                                    // Isian Singkat
                                    finalKey = document.getElementById('edit-manual-key').value.trim();
                                }
                            }

                            const payload = {
                                action: 'updateQuestion',
                                id: id,
                                question_text: qText,
                                question_class: qClass,
                                subject: qSubject,
                                question_type: qType,
                                options: JSON.stringify(finalOptions), // Sekarang hanya mengirim 2 opsi jika Benar/Salah
                                answer_key: finalKey 
                            };

                            const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                            const result = await response.json();
                            
                            if (!result.success) throw new Error(result.message || "Gagal update");

                            return { ...payload, security_token: result.token || btoa(unescape(encodeURIComponent(finalKey))) };
                        } catch (error) {
                            Swal.showValidationMessage(`Gagal: ${error.message}`);
                        }
                    }
                }).then(result => {
                    if (result.isConfirmed) {
                        const idx = allQuestions.findIndex(x => x.id === id);
                        if (idx !== -1) {
                            const val = result.value;
                            allQuestions[idx] = {
                                ...allQuestions[idx],
                                question_text: val.question_text,
                                question_class: val.question_class,
                                subject: val.subject,
                                question_type: val.question_type,
                                options: JSON.parse(val.options),
                                correct_answer: val.answer_key, 
                                security_token: val.security_token
                            };
                        }
                        Swal.fire('Sukses', 'Data berhasil diperbarui', 'success')
                        .then(() => { 
                            if (typeof renderGuruQuestionsSection === 'function') {
                                renderGuruQuestionsSection('question');
                            } else if (typeof renderQuestionsSection === 'function') {
                                renderQuestionsSection('question');
                            }
                        });
                    }
                });
                
            }
            // Fungsi untuk Encode Base64 yang aman untuk karakter unik/emoji/simbol
            function utoa(str) {
                return btoa(unescape(encodeURIComponent(str)));
            }

            // Fungsi untuk Decode Base64 yang aman
            function atou(str) {
                try {
                    return decodeURIComponent(escape(atob(str)));
                } catch (e) {
                    return atob(str); // Fallback jika bukan UTF-8 encoded
                }
            }

            async function showAddQuestionForm() {
                const newId = "question_" + Date.now();

                Swal.fire({
                    title: 'âž• Tambah Soal Baru',
                    width: '800px',
                    html: `
                        <style>
                            .editor-container { cursor: text; transition: all 0.2s; border-width: 2px !important; }
                            .editor-container:focus-within { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
                            .ql-editor { min-height: 100px; font-size: 15px; }
                            .ql-container.ql-snow { border: none !important; }
                            .ql-toolbar.ql-snow { border: none !important; border-bottom: 1px solid #f0f0f0 !important; background: #fafafa; border-radius: 8px 8px 0 0; }
                            .box-soal { border-color: #3b82f6 !important; background-color: #eff6ff; }
                            .box-a { border-color: #10b981 !important; background-color: #ecfdf5; }
                            label.title-opt { padding: 4px 12px; border-radius: 20px; color: white; display: inline-block; margin-bottom: 6px; }
                        </style>

                        <div class="text-left space-y-6" style="max-height: 75vh; overflow-y: auto; padding: 15px;">
                            <div class="grid grid-cols-3 gap-4 bg-gray-100 p-4 rounded-xl">
                                <div>
                                    <label class="block text-xs font-black text-gray-500 uppercase mb-1">Jenjang Kelas</label>
                                    <select id="add-class" class="w-full p-2 border-0 rounded-lg shadow-sm text-sm">
                                        <option value="7">Kelas 7</option><option value="8">Kelas 8</option><option value="9">Kelas 9</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-gray-500 uppercase mb-1">Mata Pelajaran</label>
                                    <select id="add-subject" class="w-full p-2 border-0 rounded-lg shadow-sm text-sm">
                                        ${(typeof SUBJECTS !== 'undefined' ? SUBJECTS : ['Matematika', 'IPA', 'Bahasa Indonesia', 'Bahasa Inggris']).map(s => `<option value="${s}">${s}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-purple-600 uppercase mb-1">Tipe Soal</label>
                                    <select id="add-type" class="w-full p-2 border-2 border-purple-200 rounded-lg shadow-sm font-bold text-sm">
                                        <option value="pilihan_ganda">Pilihan Ganda</option>
                                        <option value="pilihan_ganda_kompleks">PG Kompleks</option>
                                        <option value="benar_salah">Benar / Salah</option>
                                        <option value="isian_singkat">Isian / Essai</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="title-opt bg-blue-600 text-xs font-bold uppercase">Pertanyaan Utama</label>
                                <div id="add-q-text" class="editor-container box-soal bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="min-height: 140px;"></div>
                            </div>
                            
                            <div id="options-wrapper" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div id="cont-opt-0">
                                        <label class="title-opt bg-emerald-500 text-xs font-bold uppercase">Opsi A</label>
                                        <div id="add-opt-0" class="editor-container box-a bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="height: 110px;"></div>
                                    </div>
                                    <div id="cont-opt-1">
                                        <label class="title-opt bg-emerald-500 text-xs font-bold uppercase">Opsi B</label>
                                        <div id="add-opt-1" class="editor-container box-a bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="height: 110px;"></div>
                                    </div>
                                    <div id="cont-opt-2">
                                        <label class="title-opt bg-emerald-500 text-xs font-bold uppercase">Opsi C</label>
                                        <div id="add-opt-2" class="editor-container box-a bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="height: 110px;"></div>
                                    </div>
                                    <div id="cont-opt-3">
                                        <label class="title-opt bg-emerald-500 text-xs font-bold uppercase">Opsi D</label>
                                        <div id="add-opt-3" class="editor-container box-a bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="height: 110px;"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 p-4 border-t-2 border-green-500 bg-green-50 rounded-xl shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div class="flex-shrink-0">
                                    <label class="text-sm font-black text-green-700 flex items-center">
                                        <span class="mr-2 text-lg">âœ…</span> KUNCI JAWABAN:
                                    </label>
                                </div>

                                <div id="key-dropdown-container" class="flex-grow max-w-xs">
                                    <select id="select-correct-opt" class="w-full p-2 border-2 border-green-300 rounded-lg text-lg font-black text-green-800 outline-none">
                                        <option value="0">A</option><option value="1">B</option>
                                        <option id="drop-opt-2" value="2">C</option><option id="drop-opt-3" value="3">D</option>
                                    </select>
                                </div>

                                <div id="key-manual-container" class="flex-grow max-w-md" style="display: none;">
                                    <input type="text" id="manual-key-input" class="w-full p-2 border-2 border-gray-300 rounded-lg font-bold" placeholder="Ketik jawaban...">
                                </div>
                                
                                <div class="flex-shrink-0">
                                    <p class="text-[10px] text-green-600 font-medium italic" id="key-hint-text">*Pilih huruf jawaban benar</p>
                                </div>
                            </div>
                        </div>
                    `,
                    didOpen: () => {
                        const config = { 
                            modules: { toolbar: [['bold', 'italic', 'underline'], ['image', 'formula'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean']] }, 
                            theme: 'snow', 
                            placeholder: 'Ketik di sini...' 
                        };
                        
                        window.addEditors = {
                            question: new Quill('#add-q-text', config),
                            opt0: new Quill('#add-opt-0', config),
                            opt1: new Quill('#add-opt-1', config),
                            opt2: new Quill('#add-opt-2', config),
                            opt3: new Quill('#add-opt-3', config)
                        };

                        const typeSelect = document.getElementById('add-type');
                        const handleUIChange = () => {
                            const type = typeSelect.value;
                            const isBS = type === 'benar_salah';
                            const isPG = type === 'pilihan_ganda';
                            const isComplex = type === 'pilihan_ganda_kompleks';
                            const isEssay = type === 'isian_singkat';

                            // Kontrol visibilitas Opsi C dan D
                            document.getElementById('cont-opt-2').style.display = (isPG || isComplex) ? 'block' : 'none';
                            document.getElementById('cont-opt-3').style.display = (isPG || isComplex) ? 'block' : 'none';
                            document.getElementById('drop-opt-2').style.display = isPG ? 'block' : 'none';
                            document.getElementById('drop-opt-3').style.display = isPG ? 'block' : 'none';
                            document.getElementById('options-wrapper').style.display = isEssay ? 'none' : 'block';

                            const useDropdown = isPG || isBS;
                            document.getElementById('key-dropdown-container').style.display = useDropdown ? 'block' : 'none';
                            document.getElementById('key-manual-container').style.display = useDropdown ? 'none' : 'block';

                            // Auto-fill Benar/Salah
                            if (isBS) {
                                window.addEditors.opt0.root.innerHTML = '<p>Benar</p>';
                                window.addEditors.opt1.root.innerHTML = '<p>Salah</p>';
                            }

                            document.getElementById('key-hint-text').textContent = isComplex ? "*Gunakan koma (Contoh: A, C)" : (isEssay ? "*Ketik jawaban singkat" : "*Pilih huruf jawaban benar");
                        };

                        typeSelect.addEventListener('change', handleUIChange);
                        handleUIChange();
                    },
                    showCancelButton: true,
                    confirmButtonText: 'ðŸ’¾ Simpan Soal',
                    confirmButtonColor: '#10B981',
                    preConfirm: async () => {
                        try {
                            const type = document.getElementById('add-type').value;
                            const processEditor = async (ed) => {
                                const imgs = ed.root.querySelectorAll('img');
                                for (let img of imgs) {
                                    if (img.src.startsWith('data:image') && typeof compressImage === 'function') {
                                        img.src = await compressImage(img.src);
                                    }
                                }
                                return ed.root.innerHTML;
                            };

                            Swal.showLoading();
                            const qText = await processEditor(window.addEditors.question);
                            let finalOptions = [], key = "";

                            if (type !== 'isian_singkat') {
                                // Ambil semua input mentah
                                const rawOptions = [
                                    await processEditor(window.addEditors.opt0),
                                    await processEditor(window.addEditors.opt1),
                                    await processEditor(window.addEditors.opt2),
                                    await processEditor(window.addEditors.opt3)
                                ];

                                // --- LOGIKA UTAMA: Potong Opsi jika Benar/Salah ---
                                if (type === 'benar_salah') {
                                    finalOptions = rawOptions.slice(0, 2); // Hanya simpan A dan B
                                } else {
                                    finalOptions = rawOptions; // Simpan semua A, B, C, D
                                }

                                // Penentuan Kunci
                                if (type === 'pilihan_ganda' || type === 'benar_salah') {
                                    const selectedIdx = document.getElementById('select-correct-opt').value;
                                    key = finalOptions[selectedIdx]; 
                                } else if (type === 'pilihan_ganda_kompleks') {
                                    key = document.getElementById('manual-key-input').value.toUpperCase().replace(/\s+/g, '').split(',').filter(k => k !== '').join(',');
                                    if (!key) throw new Error("Kunci jawaban kompleks harus diisi");
                                } else {
                                    key = document.getElementById('manual-key-input').value;
                                }
                            } else {
                                key = document.getElementById('manual-key-input').value.trim();
                            }

                            const payload = {
                                action: 'addQuestion',
                                id: newId,
                                question_text: qText,
                                question_class: document.getElementById('add-class').value,
                                subject: document.getElementById('add-subject').value,
                                question_type: type,
                                options: JSON.stringify(finalOptions), // Hanya berisi 2 data jika B/S
                                answer_key: key
                            };

                            const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                            const resJson = await response.json();
                            if (!resJson.success) throw new Error(resJson.message);

                            return { ...payload, security_token: btoa(unescape(encodeURIComponent(key))) };
                        } catch (err) {
                            Swal.showValidationMessage(`Gagal: ${err.message}`);
                        }
                    }
                }).then(result => {
                    if (result.isConfirmed) {
                        allQuestions.push({
                            ...result.value,
                            options: JSON.parse(result.value.options),
                            correct_answer: result.value.answer_key
                        });
                        Swal.fire('Tersimpan!', 'Soal berhasil ditambahkan.', 'success').then(() => {
                            if(typeof renderQuestionsSection === 'function') renderQuestionsSection();
                        });
                    }
                });
            }

            function showGuruAddQuestionForm() { //guru nambah soal
                const newId = "question_" + Date.now();

                const isGuru = currentUser.role === 'GURU' || currentUser.role === 'guru';
                // Tentukan opsi kelas (Jika guru punya kelas, kunci ke kelas itu saja)
                let classOptions = "";
                if (isGuru && currentUser.class) {
                    classOptions = `<option value="${currentUser.class}">Kelas ${currentUser.class}</option>`;
                } else {
                    classOptions = `<option value="7">Kelas 7</option><option value="8">Kelas 8</option><option value="9">Kelas 9</option>`;
                }

                // Tentukan opsi mapel (Kunci ke mapel guru)
                const subjectOptions = isGuru 
                    ? `<option value="${currentUser.subject}">${currentUser.subject}</option>` 
                    : (typeof SUBJECTS !== 'undefined' ? SUBJECTS : []).map(s => `<option value="${s}">${s}</option>`).join('');

                Swal.fire({
                    title: 'âž• Tambah Soal Baru',
                    width: '800px',
                    html: `
                        <style>
                            .editor-container { cursor: text; transition: all 0.2s; border-width: 2px !important; }
                            .editor-container:focus-within { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
                            .ql-editor { min-height: 100px; font-size: 15px; }
                            .ql-container.ql-snow { border: none !important; }
                            .ql-toolbar.ql-snow { border: none !important; border-bottom: 1px solid #f0f0f0 !important; background: #fafafa; border-radius: 8px 8px 0 0; }
                            .box-soal { border-color: #3b82f6 !important; background-color: #eff6ff; }
                            .box-a { border-color: #10b981 !important; background-color: #ecfdf5; }
                            label.title-opt { padding: 4px 12px; border-radius: 20px; color: white; display: inline-block; margin-bottom: 6px; }
                        </style>

                        <div class="text-left space-y-6" style="max-height: 75vh; overflow-y: auto; padding: 15px;">
                            <div class="grid grid-cols-3 gap-4 bg-gray-100 p-4 rounded-xl">
                                <div>
                                    <label class="block text-xs font-black text-gray-500 uppercase mb-1">Jenjang Kelas</label>
                                    <select id="add-class" class="w-full p-2 border-0 rounded-lg shadow-sm bg-gray-200 text-sm" ${isGuru ? 'disabled' : ''}>
                                        ${classOptions}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-gray-500 uppercase mb-1">Mata Pelajaran</label>
                                    <select id="add-subject" class="w-full p-2 border-0 rounded-lg shadow-sm bg-gray-200 text-sm" ${isGuru ? 'disabled' : ''}>
                                        ${subjectOptions}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-purple-600 uppercase mb-1">Tipe Soal</label>
                                    <select id="add-type" class="w-full p-2 border-2 border-purple-200 rounded-lg shadow-sm font-bold text-sm">
                                        <option value="pilihan_ganda">Pilihan Ganda</option>
                                        <option value="pilihan_ganda_kompleks">PG Kompleks</option>
                                        <option value="benar_salah">Benar / Salah</option>
                                        <option value="isian_singkat">Isian / Essai</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="title-opt bg-blue-600 text-xs font-bold uppercase">Pertanyaan Utama</label>
                                <div id="add-q-text" class="editor-container box-soal bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="min-height: 140px;"></div>
                            </div>
                            
                            <div id="options-wrapper" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div id="cont-opt-0">
                                        <label class="title-opt bg-emerald-500 text-xs font-bold uppercase">Opsi A</label>
                                        <div id="add-opt-0" class="editor-container box-a bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="height: 110px;"></div>
                                    </div>
                                    <div id="cont-opt-1">
                                        <label class="title-opt bg-emerald-500 text-xs font-bold uppercase">Opsi B</label>
                                        <div id="add-opt-1" class="editor-container box-a bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="height: 110px;"></div>
                                    </div>
                                    <div id="cont-opt-2">
                                        <label class="title-opt bg-emerald-500 text-xs font-bold uppercase">Opsi C</label>
                                        <div id="add-opt-2" class="editor-container box-a bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="height: 110px;"></div>
                                    </div>
                                    <div id="cont-opt-3">
                                        <label class="title-opt bg-emerald-500 text-xs font-bold uppercase">Opsi D</label>
                                        <div id="add-opt-3" class="editor-container box-a bg-white shadow-sm border-2 rounded-xl overflow-hidden" style="height: 110px;"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 p-4 border-t-2 border-green-500 bg-green-50 rounded-xl shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div class="flex-shrink-0">
                                    <label class="text-sm font-black text-green-700 flex items-center">
                                        <span class="mr-2 text-lg">âœ…</span> KUNCI JAWABAN:
                                    </label>
                                </div>

                                <div id="key-dropdown-container" class="flex-grow max-w-xs">
                                    <select id="select-correct-opt" class="w-full p-2 border-2 border-green-300 rounded-lg text-lg font-black text-green-800 outline-none">
                                        <option value="0">A</option><option value="1">B</option>
                                        <option id="drop-opt-2" value="2">C</option><option id="drop-opt-3" value="3">D</option>
                                    </select>
                                </div>

                                <div id="key-manual-container" class="flex-grow max-w-md" style="display: none;">
                                    <input type="text" id="manual-key-input" class="w-full p-2 border-2 border-gray-300 rounded-lg font-bold" placeholder="Ketik jawaban...">
                                </div>
                                
                                <div class="flex-shrink-0">
                                    <p class="text-[10px] text-green-600 font-medium italic" id="key-hint-text">*Pilih huruf jawaban benar</p>
                                </div>
                            </div>
                        </div>
                    `,
                    didOpen: () => {
                        const config = { 
                            modules: { toolbar: [['bold', 'italic', 'underline'], ['image', 'formula'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean']] }, 
                            theme: 'snow', 
                            placeholder: 'Ketik di sini...' 
                        };
                        
                        window.addEditors = {
                            question: new Quill('#add-q-text', config),
                            opt0: new Quill('#add-opt-0', config),
                            opt1: new Quill('#add-opt-1', config),
                            opt2: new Quill('#add-opt-2', config),
                            opt3: new Quill('#add-opt-3', config)
                        };

                        const typeSelect = document.getElementById('add-type');
                        const handleUIChange = () => {
                            const type = typeSelect.value;
                            const isBS = type === 'benar_salah';
                            const isPG = type === 'pilihan_ganda';
                            const isComplex = type === 'pilihan_ganda_kompleks';
                            const isEssay = type === 'isian_singkat';

                            // Kontrol visibilitas Opsi C dan D
                            document.getElementById('cont-opt-2').style.display = (isPG || isComplex) ? 'block' : 'none';
                            document.getElementById('cont-opt-3').style.display = (isPG || isComplex) ? 'block' : 'none';
                            document.getElementById('drop-opt-2').style.display = isPG ? 'block' : 'none';
                            document.getElementById('drop-opt-3').style.display = isPG ? 'block' : 'none';
                            document.getElementById('options-wrapper').style.display = isEssay ? 'none' : 'block';

                            const useDropdown = isPG || isBS;
                            document.getElementById('key-dropdown-container').style.display = useDropdown ? 'block' : 'none';
                            document.getElementById('key-manual-container').style.display = useDropdown ? 'none' : 'block';

                            // Auto-fill Benar/Salah
                            if (isBS) {
                                window.addEditors.opt0.root.innerHTML = '<p>Benar</p>';
                                window.addEditors.opt1.root.innerHTML = '<p>Salah</p>';
                            }

                            document.getElementById('key-hint-text').textContent = isComplex ? "*Gunakan koma (Contoh: A, C)" : (isEssay ? "*Ketik jawaban singkat" : "*Pilih huruf jawaban benar");
                        };

                        typeSelect.addEventListener('change', handleUIChange);
                        handleUIChange();
                    },
                    showCancelButton: true,
                    confirmButtonText: 'ðŸ’¾ Simpan Soal',
                    confirmButtonColor: '#10B981',
                    preConfirm: async () => {

                        const qClass = isGuru ? currentUser.class : document.getElementById('add-class').value;
                        const qSubject = isGuru ? currentUser.subject : document.getElementById('add-subject').value;
                        try {
                            const type = document.getElementById('add-type').value;
                            const processEditor = async (ed) => {
                                const imgs = ed.root.querySelectorAll('img');
                                for (let img of imgs) {
                                    if (img.src.startsWith('data:image') && typeof compressImage === 'function') {
                                        img.src = await compressImage(img.src);
                                    }
                                }
                                return ed.root.innerHTML;
                            };

                            Swal.showLoading();
                            const qText = await processEditor(window.addEditors.question);
                            let finalOptions = [], key = "";

                            if (type !== 'isian_singkat') {
                                // Ambil semua input mentah
                                const rawOptions = [
                                    await processEditor(window.addEditors.opt0),
                                    await processEditor(window.addEditors.opt1),
                                    await processEditor(window.addEditors.opt2),
                                    await processEditor(window.addEditors.opt3)
                                ];

                                // --- LOGIKA UTAMA: Potong Opsi jika Benar/Salah ---
                                if (type === 'benar_salah') {
                                    finalOptions = rawOptions.slice(0, 2); // Hanya simpan A dan B
                                } else {
                                    finalOptions = rawOptions; // Simpan semua A, B, C, D
                                }

                                // Penentuan Kunci
                                if (type === 'pilihan_ganda' || type === 'benar_salah') {
                                    const selectedIdx = document.getElementById('select-correct-opt').value;
                                    key = finalOptions[selectedIdx]; 
                                } else if (type === 'pilihan_ganda_kompleks') {
                                    key = document.getElementById('manual-key-input').value.toUpperCase().replace(/\s+/g, '').split(',').filter(k => k !== '').join(',');
                                    if (!key) throw new Error("Kunci jawaban kompleks harus diisi");
                                } else {
                                    key = document.getElementById('manual-key-input').value;
                                }
                            } else {
                                key = document.getElementById('manual-key-input').value.trim();
                            }

                            const payload = {
                                action: 'addQuestion',
                                id: newId,
                                question_text: qText,
                                question_class: qClass, //document.getElementById('add-class').value,
                                subject: qSubject, //document.getElementById('add-subject').value,
                                question_type: type,
                                options: JSON.stringify(finalOptions), // Hanya berisi 2 data jika B/S
                                answer_key: key
                            };

                            const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                            const resJson = await response.json();
                            if (!resJson.success) throw new Error(resJson.message);

                            return { ...payload, security_token: btoa(unescape(encodeURIComponent(key))) };
                        } catch (err) {
                            Swal.showValidationMessage(`Gagal: ${err.message}`);
                        }
                    }
                }).then(result => {
                    if (result.isConfirmed && result.value) {
                        // 1. MASUKKAN soal baru ke dalam array lokal agar langsung tampil
                        if (typeof allQuestions !== 'undefined') {
                            allQuestions.push(result.value);
                        }

                        // 2. Jalankan Toast sukses
                        showToast('Soal berhasil ditambahkan!', 'success');

                        // 3. Panggil fungsi render berdasarkan role (seperti logika hapus tadi)
                        if (typeof currentUser !== 'undefined' && currentUser.role === 'guru') {
                            if (typeof renderGuruQuestionsSection === 'function') {
                                renderGuruQuestionsSection();
                            }
                        } else {
                            if (typeof renderQuestionsSection === 'function') {
                                renderQuestionsSection();
                            }
                        }
                    }
                });
            }

            function updateQuestionForm() {
                const type = document.getElementById('qType').value;
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                
                const optionsContainer = document.getElementById('optionsContainer');
                const answerContainer = document.getElementById('answerContainer');
                
                if (type === 'pilihan_ganda' || type === 'pilihan_ganda_kompleks') {
                    optionsContainer.innerHTML = `
                        <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Opsi Jawaban (pisahkan dengan enter)</label>
                        <textarea id="qOptions" required rows="5"
                            placeholder="Opsi A&#10;Opsi B&#10;Opsi C&#10;Opsi D"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                            style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;"></textarea>
                    `;
                    
                    if (type === 'pilihan_ganda') {
                        answerContainer.innerHTML = `
                            <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Kunci Jawaban</label>
                            <input type="text" id="qAnswer" required
                                placeholder="Masukkan jawaban yang benar"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                        `;
                    } else {
                        answerContainer.innerHTML = `
                            <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Kunci Jawaban (pisahkan dengan koma)</label>
                            <input type="text" id="qAnswer" required
                                placeholder="Opsi A,Opsi C"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                        `;
                    }
                } else if (type === 'isian_singkat') {
                    optionsContainer.innerHTML = '';
                    answerContainer.innerHTML = `
                        <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Kunci Jawaban</label>
                        <input type="text" id="qAnswer" required
                            placeholder="Jawaban yang benar"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                            style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                    `;
                } else if (type === 'benar_salah') {
                    optionsContainer.innerHTML = `
                        <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Pernyataan (pisahkan dengan enter)</label>
                        <textarea id="qOptions" required rows="5"
                            placeholder="Pernyataan 1&#10;Pernyataan 2&#10;Pernyataan 3"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                            style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;"></textarea>
                    `;
                    answerContainer.innerHTML = `
                        <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Kunci Jawaban (format: 0:Benar,1:Salah,2:Benar)</label>
                        <input type="text" id="qAnswer" required
                            placeholder="0:Benar,1:Salah,2:Benar"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                            style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                    `;
                }
            }

            async function addQuestion(e) {
                e.preventDefault();
                
                const qClass = document.getElementById('qClass').value;
                const subject = document.getElementById('qSubject').value;
                const type = document.getElementById('qType').value;
                const text = document.getElementById('qText').value;
                const image = document.getElementById('qImage').value;
                
                let options = [];
                let answer = '';
                
                if (type === 'pilihan_ganda' || type === 'pilihan_ganda_kompleks' || type === 'benar_salah') {
                    const optionsText = document.getElementById('qOptions').value;
                    options = optionsText.split('\n').filter(o => o.trim() !== '');
                }
                
                const answerInput = document.getElementById('qAnswer').value;
                
                if (type === 'pilihan_ganda_kompleks') {
                    answer = JSON.stringify(answerInput.split(',').map(a => a.trim()));
                } else if (type === 'benar_salah') {
                    const answerObj = {};
                    answerInput.split(',').forEach(pair => {
                        const [index, value] = pair.split(':');
                        answerObj[index.trim()] = value.trim();
                    });
                    answer = JSON.stringify(answerObj);
                } else {
                    answer = answerInput;
                }
                
                const questionData = {
                    question_class: qClass,
                    subject: subject,
                    question_type: type,
                    question_text: text,
                    question_image: image,
                    options: JSON.stringify(options),
                    answer_key: answer
                };
                
                const success = await saveQuestionToSheet(questionData);
                
                if (success) {
                    hideAddQuestionForm();
                    showToast('Soal berhasil ditambahkan!', 'success');
                    renderQuestionsSection();
                }
            }

            function hideAddQuestionForm() {
                document.getElementById('questionFormContainer').style.display = 'none';
            }

            async function deleteQuestion(questionId) {
                // Membuat modal konfirmasi manual
                const confirmDiv = document.createElement('div');
                confirmDiv.id = 'delete-modal'; 
                confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]';
                confirmDiv.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-sm shadow-xl transform transition-all">
                        <h3 class="text-lg font-bold mb-2 text-gray-800">Konfirmasi Hapus</h3>
                        <p class="mb-5 text-gray-600">Yakin ingin menghapus soal ini? Tindakan ini tidak dapat dibatalkan.</p>
                        <div class="flex justify-end gap-3">
                            <button onclick="this.closest('#delete-modal').remove()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-semibold">Batal</button>
                            <button onclick="confirmDeleteQuestion('${questionId}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-semibold shadow-sm">Hapus Soal</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmDiv);
            }

            async function confirmDeleteQuestion(questionId) {
                // 1. Hapus popup segera
                const modal = document.getElementById('delete-modal');
                if (modal) modal.remove();
                
                // 2. Proses hapus ke database
                const success = await deleteQuestionFromSheet(questionId);
                
                if (success) {
                    // 3. Update memori lokal
                    allQuestions = allQuestions.filter(q => String(q.id) !== String(questionId));
                    
                    showToast('Soal berhasil dihapus!', 'success');

                    // 4. LOGIKA RENDER BERDASARKAN ROLE
                    // Asumsi: Variabel currentUser.role menyimpan 'admin' atau 'guru'
                    if (typeof currentUser !== 'undefined' && currentUser.role === 'guru') {
                        // Jika guru, render section khusus guru
                        if (typeof renderGuruQuestionsSection === 'function') {
                            renderGuruQuestionsSection();
                        }
                    } else {
                        // Jika admin (atau default), render section admin
                        if (typeof renderQuestionsSection === 'function') {
                            renderQuestionsSection();
                        }
                    }
                } else {
                    showToast('Gagal menghapus soal. Coba lagi.', 'error');
                }
            }

            function renderSettingsSection() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const textColor = config.text_color || defaultConfig.text_color;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                
                // Load nilai dari localStorage
                const savedMinTime = parseInt(localStorage.getItem('minTimeToSubmit') || '0');
                
                document.getElementById('adminContent').innerHTML = `
                    <div class="space-y-6">
                        <!-- Pengaturan Ujian -->
                        <div class="bg-white rounded-xl shadow-custom p-6">
                            <h2 class="font-bold mb-6" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.5}px; color: ${textColor};">âš™ï¸ Pengaturan Ujian</h2>
                            
                            <form id="settingsForm" class="space-y-6">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">Durasi Ujian (menit)</label>
                                    <input type="number" id="settingDuration" value="${examSettings.exam_duration}" min="1" required
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                        style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                                        Jumlah Soal Maksimal 
                                        <span class="text-sm text-gray-500">(0 = semua soal)</span>
                                    </label>
                                    <input type="number" id="settingMaxQuestions" value="${examSettings.max_questions || 0}" min="0" required
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                        style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;"
                                        placeholder="Masukkan 0 untuk menggunakan semua soal">
                                    <p class="text-sm text-gray-600 mt-2" style="font-family: ${customFont}, ${baseFontStack};">
                                        ðŸ’¡ Contoh: Jika diisi 20, maka setiap ujian hanya akan menampilkan maksimal 20 soal (dari total soal yang tersedia)
                                    </p>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                                        Minimum Sisa Waktu untuk Submit (menit)
                                        <span class="text-sm text-gray-500">(0 = bisa submit kapan saja)</span>
                                    </label>
                                    <input type="number" id="settingMinTimeToSubmit" value="${savedMinTime}" min="0" required
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                        style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;"
                                        placeholder="Masukkan 0 agar siswa bisa submit kapan saja">
                                    <p class="text-sm text-gray-600 mt-2" style="font-family: ${customFont}, ${baseFontStack};">
                                        ðŸ’¡ Contoh: Jika diisi 10, siswa baru bisa submit ketika sisa waktu â‰¤ 10 menit. Berguna untuk memastikan siswa menggunakan waktu ujian dengan optimal.
                                    </p>
                                    <p class="text-sm text-blue-600 mt-1" style="font-family: ${customFont}, ${baseFontStack};">
                                        â„¹ï¸ Pengaturan ini disimpan di browser (localStorage), tidak di Google Sheet
                                    </p>
                                </div>
                                
                                <div>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="settingShuffle" ${examSettings.shuffle_questions ? 'checked' : ''}
                                            class="w-5 h-5 text-blue-600 rounded">
                                        <span class="ml-3 text-gray-700" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">Acak Urutan Soal</span>
                                    </label>
                                </div>
                                
                                <div>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="settingShuffleAnswers" ${examSettings.shuffle_answers ? 'checked' : ''}
                                            class="w-5 h-5 text-blue-600 rounded">
                                        <span class="ml-3 text-gray-700" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">Acak Urutan Jawaban</span>
                                    </label>
                                </div>
                                
                                <div>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="settingShowScore" ${examSettings.show_score ? 'checked' : ''}
                                            class="w-5 h-5 text-blue-600 rounded">
                                        <span class="ml-3 text-gray-700" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">Tampilkan Nilai Setelah Ujian</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="settingLimitOneAttempt" ${examSettings.limit_one_attempt ? 'checked' : ''} class="w-5 h-5 text-blue-600 rounded">
                                        <span class="ml-3 text-gray-700" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">Batasi Siswa 1x Mengerjakan (Per Mapel)</span>
                                    </label>
                                    <p class="text-sm text-gray-500 ml-8 mt-1">Jika aktif, siswa yang sudah punya nilai tidak bisa login ke mapel tersebut.</p>
                                </div>
                                
                                <button type="submit" 
                                    class="w-full py-3 rounded-lg text-white font-semibold hover:opacity-90 transition"
                                    style="background-color: ${primaryColor}; font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px;">
                                    ðŸ’¾ Simpan Pengaturan
                                </button>
                            </form>
                        </div>
                    </div>
                `;
                
                document.getElementById('settingsForm').addEventListener('submit', saveSettings);
            }
            
            function renderScheduleSection() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const textColor = config.text_color || defaultConfig.text_color;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                
                const now = new Date();
                
                document.getElementById('adminContent').innerHTML = `
                    <div class="space-y-6">
                        <!-- Header -->
                        <div class="flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-3">
                            <div>
                                <h2 class="font-bold mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.5}px; color: ${textColor};">ðŸ“… Jadwal Ujian</h2>
                                <p class="text-sm text-gray-600" style="font-family: ${customFont}, ${baseFontStack};">Kelola mata pelajaran yang dapat diakses siswa untuk ujian</p>
                            </div>
                            <button onclick="showAddScheduleForm()" 
                                class="px-4 py-3 rounded-xl text-white font-semibold hover:opacity-90 transition shadow-lg"
                                style="background: linear-gradient(135deg, ${primaryColor}, ${config.secondary_color || defaultConfig.secondary_color}); font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">
                                âž• Tambah Jadwal
                            </button>
                        </div>
                        
                        <!-- Form Container -->
                        <div id="scheduleFormContainer" style="display: none;" class="bg-white rounded-2xl shadow-custom p-6"></div>
                        
                        <!-- Active Schedules -->
                        <div class="bg-white rounded-2xl shadow-custom p-6">
                            <h3 class="font-bold mb-4 flex items-center gap-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px; color: ${textColor};">
                                <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                                Ujian Aktif Saat Ini
                            </h3>
                            <div id="activeSchedulesList" class="space-y-3">
                                ${examSettings.active_subjects && examSettings.active_subjects.length > 0 ? 
                                    examSettings.active_subjects.filter(item => {
                                        if (!item.start_time || !item.end_time) return item.is_active;
                                        const startTime = new Date(item.start_time);
                                        const endTime = new Date(item.end_time);
                                        return now >= startTime && now <= endTime;
                                    }).map(item => `
                                        <div class="border-2 border-green-500 bg-green-50 rounded-lg p-4">
                                            <div class="flex justify-between items-start gap-3">
                                                <div class="flex-1">
                                                    <h4 class="font-bold text-lg mb-2" style="font-family: ${customFont}, ${baseFontStack}; color: ${textColor};">${item.subject}</h4>
                                                    ${item.start_time && item.end_time ? `
                                                        <div class="text-sm text-gray-600 space-y-1" style="font-family: ${customFont}, ${baseFontStack};">
                                                            <p>ðŸ• Mulai: ${new Date(item.start_time).toLocaleString('id-ID', { 
                                                                day: '2-digit', 
                                                                month: 'long', 
                                                                year: 'numeric', 
                                                                hour: '2-digit', 
                                                                minute: '2-digit' 
                                                            })}</p>
                                                            <p>ðŸ• Selesai: ${new Date(item.end_time).toLocaleString('id-ID', { 
                                                                day: '2-digit', 
                                                                month: 'long', 
                                                                year: 'numeric', 
                                                                hour: '2-digit', 
                                                                minute: '2-digit' 
                                                            })}</p>
                                                        </div>
                                                    ` : `
                                                        <p class="text-sm text-gray-600" style="font-family: ${customFont}, ${baseFontStack};">
                                                            âœ… Aktif Manual (Tanpa Jadwal)
                                                        </p>
                                                    `}
                                                </div>
                                                <button onclick="toggleSubjectActive('${item.subject}', false)" 
                                                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm flex-shrink-0"
                                                    style="font-family: ${customFont}, ${baseFontStack};">
                                                    ðŸ”’ Nonaktifkan
                                                </button>
                                            </div>
                                        </div>
                                    `).join('') 
                                    : 
                                    `<div class="text-center py-12 text-gray-400">
                                        <p class="text-xl mb-2">ðŸ“­</p>
                                        <p style="font-family: ${customFont}, ${baseFontStack};">Tidak ada ujian yang aktif saat ini</p>
                                    </div>`
                                }
                            </div>
                        </div>
                        
                        <!-- Scheduled Exams -->
                        <div class="bg-white rounded-2xl shadow-custom p-6">
                            <h3 class="font-bold mb-4" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px; color: ${textColor};">
                                ðŸ“‹ Semua Jadwal Ujian
                            </h3>
                            <div class="space-y-3">
                                ${examSettings.active_subjects && examSettings.active_subjects.length > 0 ? 
                                    examSettings.active_subjects.map(item => {
                                        let isActive = false;
                                        let statusBadge = '';
                                        let statusColor = '';
                                        
                                        if (!item.start_time || !item.end_time) {
                                            isActive = item.is_active;
                                            statusBadge = item.is_active ? 'âœ… Aktif Manual' : 'ðŸ”’ Nonaktif';
                                            statusColor = item.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                                        } else {
                                            const startTime = new Date(item.start_time);
                                            const endTime = new Date(item.end_time);
                                            
                                            if (now < startTime) {
                                                statusBadge = 'â³ Belum Dimulai';
                                                statusColor = 'bg-yellow-100 text-yellow-800';
                                            } else if (now >= startTime && now <= endTime) {
                                                isActive = true;
                                                statusBadge = 'âœ… Sedang Berlangsung';
                                                statusColor = 'bg-green-100 text-green-800';
                                            } else {
                                                statusBadge = 'â¹ï¸ Sudah Selesai';
                                                statusColor = 'bg-gray-100 text-gray-800';
                                            }
                                        }
                                        
                                        return `
                                            <div class="border-2 ${isActive ? 'border-green-500 bg-green-50' : 'border-gray-200'} rounded-lg p-4">
                                                <div class="flex justify-between items-start gap-3 mb-3">
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-2 mb-2">
                                                            <h4 class="font-bold text-lg" style="font-family: ${customFont}, ${baseFontStack}; color: ${textColor};">${item.subject}</h4>
                                                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColor}" style="font-family: ${customFont}, ${baseFontStack};">
                                                                ${statusBadge}
                                                            </span>
                                                        </div>
                                                        ${item.start_time && item.end_time ? `
                                                            <div class="text-sm text-gray-600 space-y-1" style="font-family: ${customFont}, ${baseFontStack};">
                                                                <p>ðŸ• Mulai: ${new Date(item.start_time).toLocaleString('id-ID', { 
                                                                    day: '2-digit', 
                                                                    month: 'long', 
                                                                    year: 'numeric', 
                                                                    hour: '2-digit', 
                                                                    minute: '2-digit' 
                                                                })}</p>
                                                                <p>ðŸ• Selesai: ${new Date(item.end_time).toLocaleString('id-ID', { 
                                                                    day: '2-digit', 
                                                                    month: 'long', 
                                                                    year: 'numeric', 
                                                                    hour: '2-digit', 
                                                                    minute: '2-digit' 
                                                                })}</p>
                                                            </div>
                                                        ` : `
                                                            <p class="text-sm text-gray-600" style="font-family: ${customFont}, ${baseFontStack};">
                                                                Tanpa Jadwal (Kontrol Manual)
                                                            </p>
                                                        `}
                                                    </div>
                                                    <div class="flex flex-col sm:flex-row gap-2 md:gap-3">
                                                        ${!item.start_time || !item.end_time ? `
                                                            <button onclick="toggleSubjectActive('${item.subject}', ${!item.is_active})" 
                                                                class="px-2 py-2 ${item.is_active ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded-lg transition text-xs"
                                                                style="font-family: ${customFont}, ${baseFontStack};">
                                                                ${item.is_active ? 'ðŸ”’ Nonaktifkan' : 'âœ… Aktifkan'}
                                                            </button>
                                                        ` : ''}
                                                        <button onclick="deleteSchedule('${item.subject}')" 
                                                            class="px-2 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-xs"
                                                            style="font-family: ${customFont}, ${baseFontStack};">
                                                            ðŸ—‘ï¸ Hapus
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')
                                    :
                                    `<div class="text-center py-12 text-gray-400">
                                        <p class="text-xl mb-2">ðŸ“­</p>
                                        <p style="font-family: ${customFont}, ${baseFontStack};">Belum ada jadwal ujian</p>
                                    </div>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            }
            
            function showAddScheduleForm() {
                const config = window.elementSdk?.config || defaultConfig;
                const customFont = config.font_family || defaultConfig.font_family;
                const baseFontStack = 'Arial, sans-serif';
                const baseSize = config.font_size || defaultConfig.font_size;
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                
                const container = document.getElementById('scheduleFormContainer');
                container.style.display = 'block';
                container.innerHTML = `
                    <h3 class="font-bold mb-4" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 1.125}px;">Tambah Jadwal Ujian Baru</h3>
                    <form id="addScheduleForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Mata Pelajaran</label>
                            <select id="scheduleSubject" required
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                                <option value="">Pilih Mata Pelajaran</option>
                                ${SUBJECTS.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Tipe Jadwal</label>
                            <select id="scheduleType" required onchange="toggleScheduleFields()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                                <option value="">Pilih Tipe</option>
                                <option value="manual">Manual (Kontrol Admin)</option>
                                <option value="scheduled">Terjadwal (Otomatis)</option>
                            </select>
                        </div>
                        
                        <div id="scheduledFields" style="display: none;" class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Waktu Mulai</label>
                                <input type="datetime-local" id="scheduleStart"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                    style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-medium mb-2" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.875}px;">Waktu Selesai</label>
                                <input type="datetime-local" id="scheduleEnd"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                    style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                            </div>
                        </div>
                        
                        <div id="manualFields" style="display: none;">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="scheduleIsActive"
                                    class="w-5 h-5 text-blue-600 rounded">
                                <span class="ml-3 text-gray-700" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">Aktifkan Sekarang</span>
                            </label>
                        </div>
                        
                        <div class="flex gap-3">
                            <button type="submit" 
                                class="px-6 py-2 rounded-lg text-white font-semibold hover:opacity-90 transition"
                                style="background-color: ${primaryColor}; font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                                Simpan
                            </button>
                            <button type="button" onclick="hideScheduleForm()" 
                                class="px-6 py-2 bg-gray-500 rounded-lg text-white font-semibold hover:bg-gray-600 transition"
                                style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px;">
                                Batal
                            </button>
                        </div>
                    </form>
                `;
                
                document.getElementById('addScheduleForm').addEventListener('submit', addSchedule);
            }
            
            function toggleScheduleFields() {
                const type = document.getElementById('scheduleType').value;
                const scheduledFields = document.getElementById('scheduledFields');
                const manualFields = document.getElementById('manualFields');
                const startInput = document.getElementById('scheduleStart');
                const endInput = document.getElementById('scheduleEnd');
                
                if (type === 'scheduled') {
                    scheduledFields.style.display = 'block';
                    manualFields.style.display = 'none';
                    startInput.required = true;
                    endInput.required = true;
                } else if (type === 'manual') {
                    scheduledFields.style.display = 'none';
                    manualFields.style.display = 'block';
                    startInput.required = false;
                    endInput.required = false;
                } else {
                    scheduledFields.style.display = 'none';
                    manualFields.style.display = 'none';
                    startInput.required = false;
                    endInput.required = false;
                }
            }
            
            async function addSchedule(e) {
                e.preventDefault();
                
                const subject = document.getElementById('scheduleSubject').value;
                const type = document.getElementById('scheduleType').value;
                
                // Check if subject already exists
                if (examSettings.active_subjects.some(item => item.subject === subject)) {
                    showToast('Mata pelajaran ini sudah ada dalam jadwal!', 'error');
                    return;
                }
                
                let scheduleItem = {
                    subject: subject
                };
                
                if (type === 'scheduled') {
                    const startTime = document.getElementById('scheduleStart').value;
                    const endTime = document.getElementById('scheduleEnd').value;
                    
                    if (!startTime || !endTime) {
                        showToast('Harap isi waktu mulai dan selesai!', 'error');
                        return;
                    }
                    
                    if (new Date(startTime) >= new Date(endTime)) {
                        showToast('Waktu mulai harus lebih awal dari waktu selesai!', 'error');
                        return;
                    }
                    
                    scheduleItem.start_time = new Date(startTime).toISOString();
                    scheduleItem.end_time = new Date(endTime).toISOString();
                    scheduleItem.is_active = false; // Will be determined by schedule
                } else {
                    const isActive = document.getElementById('scheduleIsActive').checked;
                    scheduleItem.is_active = isActive;
                }
                
                examSettings.active_subjects.push(scheduleItem);            
                
                const success = await saveSettingsToSheet({
                    active_subjects: JSON.stringify(examSettings.active_subjects)
                });
                
                if (success) {
                    hideScheduleForm();
                    showToast('Jadwal ujian berhasil ditambahkan!', 'success');
                    renderScheduleSection();
                }
            }
            
            function hideScheduleForm() {
                document.getElementById('scheduleFormContainer').style.display = 'none';
            }
            
            async function toggleSubjectActive(subject, newStatus) {
                const index = examSettings.active_subjects.findIndex(item => item.subject === subject);
                
                if (index !== -1) {
                    examSettings.active_subjects[index].is_active = newStatus;
                    
                    const success = await saveSettingsToSheet({
                        active_subjects: JSON.stringify(examSettings.active_subjects)
                    });
                    
                    if (success) {
                        showToast(`${subject} berhasil ${newStatus ? 'diaktifkan' : 'dinonaktifkan'}!`, 'success');
                        renderScheduleSection();
                    }
                }
            }
            
            async function deleteSchedule(subject) {
                const confirmDiv = document.createElement('div');
                confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                confirmDiv.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-sm">
                        <p class="mb-4">Yakin ingin menghapus jadwal untuk ${subject}?</p>
                        <div class="flex gap-3">
                            <button onclick="confirmDeleteSchedule('${subject}')" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Hapus</button>
                            <button onclick="this.closest('div.fixed').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Batal</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmDiv);
            }
            
            async function confirmDeleteSchedule(subject) {
                document.querySelector('div.fixed').remove();
                
                examSettings.active_subjects = examSettings.active_subjects.filter(item => item.subject !== subject);
                
                const success = await saveSettingsToSheet({
                    active_subjects: JSON.stringify(examSettings.active_subjects)
                });
                
                if (success) {
                    showToast('Jadwal berhasil dihapus!', 'success');
                    renderScheduleSection();
                }
            }

            async function saveSettings(e) {
                e.preventDefault();
                
                const duration = parseInt(document.getElementById('settingDuration').value);
                const maxQuestions = parseInt(document.getElementById('settingMaxQuestions').value);
                const minTimeToSubmitInput = document.getElementById('settingMinTimeToSubmit');
                const minTimeToSubmitValue = minTimeToSubmitInput.value.trim() === '' ? 0 : parseInt(minTimeToSubmitInput.value);
                const shuffle = document.getElementById('settingShuffle').checked;
                const shuffleAnswers = document.getElementById('settingShuffleAnswers').checked;
                const showScore = document.getElementById('settingShowScore').checked;
                const limitOneAttempt = document.getElementById('settingLimitOneAttempt').checked;
                
                // Validasi: pastikan minTimeToSubmit adalah angka yang valid
                if (isNaN(minTimeToSubmitValue) || minTimeToSubmitValue < 0) {
                    showToast('Minimum sisa waktu harus berupa angka 0 atau lebih!', 'error');
                    return;
                }
                
                // Validasi: min_time_to_submit tidak boleh lebih besar dari exam_duration
                if (minTimeToSubmitValue > duration) {
                    showToast('Minimum sisa waktu untuk submit tidak boleh lebih besar dari durasi ujian!', 'error');
                    return;
                }
                
                // Simpan minimum waktu submit ke localStorage (tidak ke Google Sheet)
                localStorage.setItem('minTimeToSubmit', minTimeToSubmitValue.toString());
                minTimeToSubmit = minTimeToSubmitValue;
                
                // Simpan pengaturan lain ke Google Sheet (tanpa min_time_to_submit)
                const settingsData = {
                    exam_duration: duration,
                    max_questions: maxQuestions,
                    shuffle_questions: shuffle,
                    shuffle_answers: shuffleAnswers,
                    limit_one_attempt: limitOneAttempt,
                    show_score: showScore
                };
                
                const success = await saveSettingsToSheet(settingsData);
                
                if (success) {
                    examSettings.exam_duration = duration;
                    examSettings.max_questions = maxQuestions;
                    examSettings.shuffle_questions = shuffle;
                    examSettings.shuffle_answers = shuffleAnswers;
                    examSettings.show_score = showScore;
                    
                    showToast('Pengaturan ujian berhasil disimpan!', 'success');
                }
            }

            async function refreshTarget(target) {
                try {
                    showLoading(); // Tampilkan overlay loading
                    
                    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAllData`);
                    const data = await response.json();
                    
                    if (data.success) {
                        allUsers = data.users || [];
                        allExamResults = data.examResults || [];
                        allQuestions = data.questions || [];
                        if (target === 'users') {
                            renderUsersSection();
                            showToast('Data Pengguna berhasil diperbarui', 'success');
                        } else if (target === 'examResults') {
                            renderResultsSection();
                            showToast('Data berhasil diperbarui', 'success');
                        } else if (target === 'questions') {
                            if (currentUser.role === 'admin') {
                                renderQuestionsSection();
                            } else {
                                renderGuruQuestionsSection();
                            }
                            showToast('Bank Soal berhasil diperbarui', 'success');
                        }
                    }
                } catch (error) {
                    showToast('Gagal refresh data', 'error');
                } finally {
                    hideLoading(); // Sembunyikan loading
                }
            }

            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white font-semibold shadow-lg transition z-50 ${
                    type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
                }`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            // ============================================
            // ELEMENT SDK
            // ============================================
            async function onConfigChange(config) {
                const appElement = document.getElementById('app');
                if (!appElement) return;
                
                if (currentUser && currentUser.role === 'admin') {
                    renderAdminDashboard();
                } else if (currentUser && currentUser.role === 'siswa') {
                    renderExamPage();
                } else {
                    renderLoginPage();
                }
            }

            const capabilities = {
                recolorables: [
                    {
                        get: () => window.elementSdk?.config?.primary_color || defaultConfig.primary_color,
                        set: (value) => {
                            if (window.elementSdk?.config) {
                                window.elementSdk.config.primary_color = value;
                                window.elementSdk.setConfig({ primary_color: value });
                            }
                        }
                    },
                    {
                        get: () => window.elementSdk?.config?.secondary_color || defaultConfig.secondary_color,
                        set: (value) => {
                            if (window.elementSdk?.config) {
                                window.elementSdk.config.secondary_color = value;
                                window.elementSdk.setConfig({ secondary_color: value });
                            }
                        }
                    },
                    {
                        get: () => window.elementSdk?.config?.background_color || defaultConfig.background_color,
                        set: (value) => {
                            if (window.elementSdk?.config) {
                                window.elementSdk.config.background_color = value;
                                window.elementSdk.setConfig({ background_color: value });
                            }
                        }
                    },
                    {
                        get: () => window.elementSdk?.config?.text_color || defaultConfig.text_color,
                        set: (value) => {
                            if (window.elementSdk?.config) {
                                window.elementSdk.config.text_color = value;
                                window.elementSdk.setConfig({ text_color: value });
                            }
                        }
                    },
                    {
                        get: () => window.elementSdk?.config?.button_color || defaultConfig.button_color,
                        set: (value) => {
                            if (window.elementSdk?.config) {
                                window.elementSdk.config.button_color = value;
                                window.elementSdk.setConfig({ button_color: value });
                            }
                        }
                    }
                ],
                borderables: [],
                fontEditable: {
                    get: () => window.elementSdk?.config?.font_family || defaultConfig.font_family,
                    set: (value) => {
                        if (window.elementSdk?.config) {
                            window.elementSdk.config.font_family = value;
                            window.elementSdk.setConfig({ font_family: value });
                        }
                    }
                },
                fontSizeable: {
                    get: () => window.elementSdk?.config?.font_size || defaultConfig.font_size,
                    set: (value) => {
                        if (window.elementSdk?.config) {
                            window.elementSdk.config.font_size = value;
                            window.elementSdk.setConfig({ font_size: value });
                        }
                    }
                }
            };

            function mapToEditPanelValues(config) {
                return new Map([
                    ["app_title", config.app_title || defaultConfig.app_title],
                    ["school_name", config.school_name || defaultConfig.school_name],
                    ["welcome_text", config.welcome_text || defaultConfig.welcome_text],
                    ["login_button_text", config.login_button_text || defaultConfig.login_button_text]
                ]);
            }

            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange,
                    mapToCapabilities: () => capabilities,
                    mapToEditPanelValues
                });
            }

            init();
        </script>
    </body>
 </html>
